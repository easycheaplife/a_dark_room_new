# A Dark Room - 地标转换为前哨站机制

## 概述

在A Dark Room游戏中，某些地标在完全探索后会转换为前哨站（P）。这是游戏的核心进程机制，为玩家提供了水源补给点，使长距离探索成为可能。

## 🏛️ 会转换为前哨站的地标

### 1. 洞穴 (V - Cave)
- **地标符号**: `V`
- **名称**: 潮湿洞穴 (Damp Cave)
- **转换条件**: 完全探索洞穴事件
- **转换场景**: 
  - `end1`: 发现大型动物巢穴
  - `end2`: 发现小型补给缓存
  - `end3`: 发现旧箱子和钢剑
- **战利品**: 肉类、布料、皮革、铁、钢、医药等
- **原游戏代码**: `cave` setpiece事件

### 2. 废弃小镇 (O - Town)
- **地标符号**: `O`
- **名称**: 废弃小镇 (Abandoned Town)
- **转换条件**: 完全探索小镇事件
- **转换场景**:
  - `end1`: 学校中的拾荒者营地
  - `end2`: 拾荒者的补给发现
  - `end3`: 流浪者的钢铁
  - `end4`: 复仇战斗后的收获
  - `end5`: 废弃诊所的医药
  - `end6`: 被洗劫的诊所
- **战利品**: 钢剑、煤炭、步枪、熏肉、医药等
- **原游戏代码**: `town` setpiece事件

### 3. 废墟城市 (Y - City)
- **地标符号**: `Y`
- **名称**: 废墟城市 (Ruined City)
- **转换条件**: 完全探索城市事件
- **转换场景**: 多达15个不同的结束场景 (`end1` - `end15`)
- **主要场景类型**:
  - 鸟类巢穴发现
  - 拾荒者遗留物
  - 地下隧道战场
  - 军事前哨站
  - 士兵战斗
  - 定居点冲突
  - 医院探索
  - 触手怪物战斗
  - 扭曲人类战斗
- **战利品**: 子弹、火把、步枪、激光步枪、钢剑、能量电池、外星合金等
- **特殊标记**: 完成后设置 `game.cityCleared = true`
- **原游戏代码**: `city` setpiece事件

### 4. 被摧毁的战舰 (X - Executioner)
- **地标符号**: `X`
- **名称**: 被摧毁的战舰 (Destroyed Warship)
- **转换条件**: 击败执行者
- **转换场景**: `end` - 水晶脉冲后执行者消失
- **战利品**: 通常包含高级装备
- **原游戏代码**: `executioner` setpiece事件

## 🚫 不会转换为前哨站的地标

### 矿山类地标
- **铁矿 (I)**: 只标记为已访问，不转换
- **煤矿 (C)**: 只标记为已访问，不转换  
- **硫磺矿 (S)**: 只标记为已访问，不转换

### 其他地标
- **旧房子 (H)**: 只标记为已访问，不转换
- **钻孔 (B)**: 只标记为已访问，不转换
- **战场 (F)**: 只标记为已访问，不转换
- **阴暗沼泽 (M)**: 只标记为已访问，不转换
- **被摧毁的村庄 (U)**: 只标记为已访问，不转换
- **坠毁星舰 (W)**: 特殊处理，不转换为前哨站

## 🔄 转换机制

### 技术实现
```javascript
// 原游戏 JavaScript 代码
clearDungeon: function() {
    Engine.event('progress', 'dungeon cleared');
    // 将当前位置转换为前哨站
    World.state.map[World.curPos[0]][World.curPos[1]] = World.TILE.OUTPOST;
    // 自动连接道路
    World.drawRoad();
}
```

```dart
// Flutter 版本 Dart 代码
void clearDungeon() {
  // 转换为前哨站
  map[curPos[0]][curPos[1]] = tile['outpost']!;
  // 绘制道路连接
  drawRoad();
  // 标记为已使用
  markOutpostUsed();
  // 更新显示
  notifyListeners();
}
```

### 转换流程
1. **探索阶段**: 玩家进入地标，触发setpiece事件
2. **挑战阶段**: 面对战斗、选择和风险
3. **完成阶段**: 到达特定的结束场景（end1, end2等）
4. **转换阶段**: 调用 `clearDungeon()` 函数
5. **结果阶段**: 地标转换为前哨站，自动连接道路

## 🎯 前哨站特性

### 功能
- **水源补给**: 恢复到最大水容量
- **一次性使用**: 每个前哨站只能使用一次
- **道路连接**: 自动连接到道路网络
- **战略价值**: 允许更深入的探索

### 视觉状态
- **未使用前哨站**: 地图显示为黑色 `P`
- **已使用前哨站**: 地图显示为灰色 `P`

## 📊 统计信息

### 可转换地标数量
- **洞穴**: 5个（游戏中生成）
- **废弃小镇**: 10个（游戏中生成）
- **废墟城市**: 20个（游戏中生成）
- **执行者**: 1个（固定位置）

### 总计前哨站潜力
- **理论最大值**: 36个前哨站
- **实际可获得**: 取决于玩家探索和战斗能力

## 🔧 开发实现状态

### Flutter版本已实现
✅ 洞穴事件转换机制  
✅ 废弃小镇事件转换机制  
✅ 废墟城市事件转换机制  
✅ 执行者事件转换机制  
✅ `clearDungeon()` 函数正确实现  
✅ 前哨站使用状态管理  
✅ 道路自动连接功能  

### 相关文件
- `lib/modules/world.dart` - 核心转换逻辑
- `lib/modules/setpieces.dart` - 地标事件处理
- `lib/modules/events.dart` - 事件系统
- `lib/screens/world_screen.dart` - 地图显示

## 📝 注意事项

1. **只有完全探索才转换**: 中途离开地标不会触发转换
2. **转换是永久的**: 一旦转换为前哨站就无法逆转
3. **使用是一次性的**: 前哨站使用后变为灰色，无法再次使用
4. **道路自动连接**: 转换后会自动绘制道路连接到前哨站
5. **战略规划重要**: 前哨站位置影响探索范围和效率

## 🔍 原游戏代码分析

### setpieces.js 中的转换调用
```javascript
// 洞穴事件 - 3个结束场景都调用clearDungeon
'end1': { onLoad: function() { World.clearDungeon(); } },
'end2': { onLoad: function() { World.clearDungeon(); } },
'end3': { onLoad: function() { World.clearDungeon(); } },

// 小镇事件 - 6个结束场景都调用clearDungeon
'end1': { onLoad: function() { World.clearDungeon(); } },
'end2': { onLoad: function() { World.clearDungeon(); } },
// ... end3 到 end6

// 城市事件 - 15个结束场景都调用clearDungeon + cityCleared标记
'end1': { onLoad: function() { World.clearDungeon(); $SM.set('game.cityCleared', true); } },
// ... end2 到 end15
```

### executioner.js 中的转换调用
```javascript
// 执行者事件 - 击败后转换
'end': {
  onLoad: () => { World.clearDungeon(); },
  buttons: { 'leave': { text: _('leave'), nextScene: 'end' } }
}
```

## 🎮 游戏设计意义

### 进程门控机制
前哨站系统将**探索能力**与**玩家实力**巧妙绑定：

1. **实力门槛**: 只有足够强大才能清理危险地标
2. **风险回报**: 清理地牢有战斗风险，但获得前哨站价值巨大
3. **探索扩展**: 有了前哨站才能探索更远区域
4. **资源稀缺**: 一次性使用创造紧张感和策略性

### 心理压力机制
- **谨慎规划**: 玩家必须谨慎规划前哨站使用时机
- **紧张感**: 增加了探索的紧张感和策略性
- **成就感**: 成功清理地牢获得前哨站带来成就感

---

*文档创建时间: 2024年*
*基于原游戏版本和Flutter移植版本分析*
