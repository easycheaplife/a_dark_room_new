# 微信小程序 web-view 问题诊断与解决方案

## 问题描述
微信小程序中的web-view组件显示"正在加载游戏..."后无法继续加载，即使是百度等HTTPS网站也无法显示。

## 常见原因分析

### 1. 域名白名单配置问题
**问题**: 微信小程序要求web-view加载的域名必须在小程序后台配置的业务域名白名单中。

**解决方案**:
- 登录微信公众平台小程序后台
- 进入"开发" -> "开发管理" -> "开发设置"
- 在"业务域名"中添加需要访问的域名
- 下载校验文件并上传到域名根目录

### 2. HTTPS协议要求
**问题**: 微信小程序只支持HTTPS协议的网页。

**解决方案**:
- 确保所有URL都使用HTTPS协议
- 检查证书是否有效
- 避免使用自签名证书

### 3. 开发者工具设置
**问题**: 开发者工具的安全设置可能阻止页面加载。

**解决方案**:
- 在微信开发者工具中点击"详情"
- 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
- 重新编译项目

### 4. 网页兼容性问题
**问题**: 目标网页可能不兼容微信小程序的web-view环境。

**解决方案**:
- 检查网页是否使用了不支持的API
- 确保网页在移动端浏览器中正常显示
- 避免使用弹窗、alert等可能被拦截的功能

## 诊断步骤

### 步骤1: 检查开发者工具设置
1. 打开微信开发者工具
2. 点击右上角"详情"按钮
3. 在"本地设置"中确保勾选了"不校验合法域名..."选项
4. 重新编译项目

### 步骤2: 测试简单HTTPS页面
1. 将web-view的src改为 `https://www.baidu.com`
2. 如果百度也无法显示，说明是基础配置问题
3. 如果百度可以显示，说明是目标网站的问题

### 步骤3: 检查控制台错误
1. 在开发者工具中打开调试器
2. 查看Console面板的错误信息
3. 查看Network面板的网络请求状态

### 步骤4: 检查网络连接
1. 确保设备网络连接正常
2. 尝试在浏览器中直接访问目标URL
3. 检查是否有防火墙或代理设置影响

## 针对A Dark Room项目的解决方案

### 方案1: 使用本地HTTP服务器（开发环境）
```javascript
// 在config/env.js中配置
h5Url: 'http://localhost:3000'
```
注意: 需要在开发者工具中开启"不校验合法域名"选项

### 方案2: 部署到HTTPS服务器（生产环境）
1. 将Flutter web构建产物部署到支持HTTPS的服务器
2. 配置域名白名单
3. 更新env.js中的URL配置

### 方案3: 使用云开发静态网站托管
1. 开通微信云开发
2. 使用静态网站托管功能
3. 上传Flutter web构建产物
4. 获取HTTPS访问地址

## 调试技巧

### 1. 使用真机调试
- 开发者工具的web-view表现可能与真机不同
- 使用真机调试功能进行测试

### 2. 添加错误处理
```javascript
// 在game.js中添加
onH5Error: function(e) {
  console.error('web-view加载错误:', e);
  this.setData({
    error: true,
    errorMessage: 'H5页面加载失败: ' + (e.detail.errMsg || '未知错误')
  });
}
```

### 3. 添加加载超时处理
```javascript
// 设置加载超时
setTimeout(() => {
  if (this.data.loading) {
    this.setData({
      error: true,
      errorMessage: '页面加载超时，请检查网络连接'
    });
  }
}, 10000); // 10秒超时
```

## 常见错误码说明

- `errMsg: "webview:fail invalid url"`: URL格式错误或协议不支持
- `errMsg: "webview:fail domain not in domain list"`: 域名未在白名单中
- `errMsg: "webview:fail ssl handshake error"`: SSL证书问题
- `errMsg: "webview:fail net::ERR_CONNECTION_REFUSED"`: 服务器拒绝连接

## 下一步行动建议

1. **立即执行**: 检查开发者工具设置，确保开启"不校验合法域名"选项
2. **测试验证**: 使用百度等已知可用的HTTPS网站测试web-view基础功能
3. **问题定位**: 根据控制台错误信息确定具体问题类型
4. **解决方案**: 根据问题类型选择对应的解决方案实施
