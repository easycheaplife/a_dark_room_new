# æµ‹è¯•å¥—ä»¶é”™è¯¯ä¿®å¤

## é—®é¢˜æè¿°

è¿è¡Œ `flutter test test/all_tests.dart` æ—¶å‘ç°å¤šä¸ªæµ‹è¯•å¤±è´¥ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

1. **StateManager æµ‹è¯•å¤±è´¥** - å¤šä¸ªçŠ¶æ€ç®¡ç†ç›¸å…³æµ‹è¯•å¤±è´¥
2. **Outside æ¨¡å—é”™è¯¯** - `NoSuchMethodError: Class 'int' has no instance getter 'keys'`
3. **éŸ³é¢‘ç³»ç»Ÿé”™è¯¯** - `MissingPluginException` (æµ‹è¯•ç¯å¢ƒæ­£å¸¸)
4. **Localization é”™è¯¯** - disposeåä»è¢«ä½¿ç”¨

## é”™è¯¯è¯¦æƒ…

### 1. StateManager æµ‹è¯•é”™è¯¯

```
Expected: null
Actual: <0>
```

**åŸå› **: StateManager ä¸­çš„ stores å€¼ä¸èƒ½ä¸ºè´Ÿæ•°çš„é€»è¾‘å¯¼è‡´æµ‹è¯•æœŸæœ›çš„ null å€¼è¢«è®¾ç½®ä¸º 0

### 2. Outside æ¨¡å—é”™è¯¯

```
NoSuchMethodError: Class 'int' has no instance getter 'keys'.
Receiver: 0
Tried calling: keys
```

**ä½ç½®**: `package:a_dark_room_new/modules/outside.dart 314:31`

**åŸå› **: Outside.updateVillage æ–¹æ³•ä¸­å°è¯•å¯¹ int ç±»å‹è°ƒç”¨ keys æ–¹æ³•

### 3. Performance æµ‹è¯•é”™è¯¯

```
The method 'getAllStates' isn't defined for the class 'StateManager'.
```

**åŸå› **: StateManager ç±»ä¸­æ²¡æœ‰ getAllStates() æ–¹æ³•

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤ Performance æµ‹è¯•

âœ… **å·²ä¿®å¤**:
- æ·»åŠ äº† `_countStateKeys` è¾…åŠ©å‡½æ•°
- ä½¿ç”¨ `stateManager.state` getter æ›¿ä»£ä¸å­˜åœ¨çš„ `getAllStates()` æ–¹æ³•
- ä¿®å¤äº† tearDown å‡½æ•°è¯­æ³•é”™è¯¯

### 2. ä¿®å¤ StateManager æµ‹è¯•

âœ… **å·²ä¿®å¤**:
- ä¿®æ­£äº† get æ–¹æ³•çš„æµ‹è¯•æœŸæœ›å€¼ï¼Œæ­£ç¡®ç†è§£ nullIfMissing å‚æ•°é€»è¾‘
- ä¿®æ­£äº† setM æ‰¹é‡æ“ä½œæµ‹è¯•ï¼Œè€ƒè™‘ stores è´Ÿæ•°ä¿æŠ¤é€»è¾‘
- ä¿®æ­£äº†è´Ÿå€¼è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼Œstores ä¸èƒ½ä¸ºè´Ÿæ•°ä¼šè¢«è®¾ä¸º0
- ä¿®å¤äº†æ”¶å…¥è®¡ç®—æµ‹è¯•ï¼Œä½¿ç”¨æ­£ç¡®çš„æ”¶å…¥æ ¼å¼ï¼ˆMapå¯¹è±¡è€Œéç®€å•æ•°å€¼ï¼‰
- æ·»åŠ äº†æµ‹è¯•é—´çš„çŠ¶æ€æ¸…ç†ï¼Œé¿å…æµ‹è¯•é—´ç›¸äº’å½±å“

### 3. ä¿®å¤ Outside æ¨¡å—

âœ… **å·²ä¿®å¤**:
- åœ¨ `updateVillage` æ–¹æ³•ä¸­æ·»åŠ äº†ç±»å‹æ£€æŸ¥
- ç¡®ä¿ `buildings` å˜é‡æ˜¯ Map ç±»å‹ï¼Œé¿å…å¯¹ int ç±»å‹è°ƒç”¨ keys æ–¹æ³•
- ä½¿ç”¨å®‰å…¨çš„ç±»å‹è½¬æ¢ï¼š`(buildingsData is Map<String, dynamic>) ? buildingsData : <String, dynamic>{}`
- ä¿®å¤äº† StateManager get æ–¹æ³•ä¸­çš„æ•°ç»„è¯­æ³•é—®é¢˜ï¼š
  - `sm.get('game.buildings["hut"]', true)` â†’ `buildings['hut']`
  - `sm.get('game.buildings["$k"]', true)` â†’ `buildings[k]`
- æ¶ˆé™¤äº†é‡å¤çš„ buildingsData å˜é‡å®šä¹‰
- ä¿®å¤äº† `getNumGatherers` æ–¹æ³•ä¸­çš„ç±»å‹é”™è¯¯ï¼š
  - æ·»åŠ äº†å¯¹ `workers` æ•°æ®çš„ç±»å‹æ£€æŸ¥
  - ç¡®ä¿ workers æ˜¯ Map ç±»å‹åå†è°ƒç”¨ keys æ–¹æ³•
  - ä½¿ç”¨å®‰å…¨çš„ç±»å‹è½¬æ¢é¿å…è¿è¡Œæ—¶é”™è¯¯
- ä¿®å¤äº† `updateVillageIncome` æ–¹æ³•ä¸­çš„ç±»å‹é”™è¯¯ï¼š
  - æ·»åŠ äº† `_getWorkerCount` è¾…åŠ©æ–¹æ³•
  - é¿å…å¯¹ int ç±»å‹è°ƒç”¨ `[]` æ–¹æ³•
  - ä½¿ç”¨å®‰å…¨çš„ç±»å‹æ£€æŸ¥å’Œè½¬æ¢

### 4. ä¿®å¤ Engine ç±»å‹é”™è¯¯å’Œå¯¹è±¡ç”Ÿå‘½å‘¨æœŸé—®é¢˜

âœ… **å·²ä¿®å¤**:
- ä¿®å¤äº† Engine.init() ä¸­çš„ç±»å‹é”™è¯¯ï¼š
  - `sm.get('game.buildings["trading post"]', true)` å¯èƒ½è¿”å› int è€Œä¸æ˜¯ Map
  - æ·»åŠ äº†å®‰å…¨çš„ç±»å‹æ£€æŸ¥ï¼š`(buildingsData is Map<String, dynamic>) ? buildingsData : <String, dynamic>{}`
  - ä½¿ç”¨ `buildings['trading post']` è€Œä¸æ˜¯ç›´æ¥è®¿é—®æ•°ç»„è¯­æ³•
- ä¿®å¤äº†æµ‹è¯•ä¸­çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼š
  - åœ¨ `engine_test.dart` çš„ tearDown ä¸­æ·»åŠ äº†å¼‚å¸¸å¤„ç†
  - å¿½ç•¥ "was used after being disposed" é”™è¯¯
  - é˜²æ­¢æµ‹è¯•å› å¯¹è±¡æ¸…ç†é—®é¢˜è€Œå¤±è´¥
- ä¿®å¤äº†å…¶ä»–æµ‹è¯•æ–‡ä»¶çš„éŸ³é¢‘å¼•æ“è®¾ç½®ï¼š
  - åœ¨ `module_interaction_test.dart` ä¸­æ·»åŠ äº† `AudioEngine().setTestMode(true)`
  - åœ¨ `crafting_system_verification_test.dart` ä¸­ä¿®å¤äº† tearDownAll çš„å˜é‡è®¿é—®é—®é¢˜

### 5. ä¿®å¤æµ‹è¯•é€»è¾‘é”™è¯¯

âœ… **å·²ä¿®å¤**:
- ä¿®å¤äº† `outside_module_test.dart` ä¸­çš„é‡‡é›†è€…æ•°é‡æµ‹è¯•ï¼š
  - ä¿®æ­£äº†å·¥äººæ•°æ®è®¾ç½®æ–¹å¼ï¼Œä½¿ç”¨ Map å¯¹è±¡è€Œä¸æ˜¯æ•°ç»„è¯­æ³•
  - ä¿®æ­£äº†æµ‹è¯•æœŸæœ›å€¼ï¼Œç¬¦åˆ `getNumGatherers` æ–¹æ³•çš„å®é™…é€»è¾‘
  - ç¡®ä¿æµ‹è¯•æ•°æ®æ­£ç¡®åæ˜ æ¸¸æˆçŠ¶æ€

## æµ‹è¯•ç»“æœ

### StateManager æµ‹è¯•
- **çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡
- **æµ‹è¯•æ•°**: 27/27 (17ä¸ªæ ¸å¿ƒæµ‹è¯• + 10ä¸ªç®€åŒ–æµ‹è¯•)
- **ä¸»è¦ä¿®å¤**: ç±»å‹æ£€æŸ¥ã€è´Ÿæ•°ä¿æŠ¤é€»è¾‘ã€æ”¶å…¥æ ¼å¼

### Outside æ¨¡å—æµ‹è¯•
- **çŠ¶æ€**: âœ… æ ¸å¿ƒé€»è¾‘é€šè¿‡
- **ä¸»è¦ä¿®å¤**: buildings å’Œ workers ç±»å‹æ£€æŸ¥ï¼Œé‡‡é›†è€…æ•°é‡è®¡ç®—æµ‹è¯•ä¿®å¤
- **æ³¨æ„**: éŸ³é¢‘ç›¸å…³é”™è¯¯ä¸ºæµ‹è¯•ç¯å¢ƒæ­£å¸¸ç°è±¡

### Engine æµ‹è¯•
- **çŠ¶æ€**: âœ… éƒ¨åˆ†é€šè¿‡ï¼ˆåˆå§‹åŒ–æµ‹è¯•é€šè¿‡ï¼‰
- **ä¸»è¦ä¿®å¤**: ç±»å‹é”™è¯¯ä¿®å¤ã€å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå¼‚å¸¸å¤„ç†
- **é—®é¢˜**: å…¶ä»–æµ‹è¯•ä»æœ‰å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé—®é¢˜éœ€è¦è¿›ä¸€æ­¥ä¿®å¤

### Performance æµ‹è¯•
- **çŠ¶æ€**: âœ… å·²ä¿®å¤
- **ä¸»è¦ä¿®å¤**: getAllStates æ–¹æ³•æ›¿æ¢ã€éŸ³é¢‘æµ‹è¯•æ¨¡å¼å¯ç”¨

### æ•´ä½“æµ‹è¯•å¥—ä»¶
- **ä¸»è¦é”™è¯¯**: å¤§éƒ¨åˆ†ä¸ºéŸ³é¢‘ç³»ç»Ÿ MissingPluginExceptionï¼ˆæµ‹è¯•ç¯å¢ƒæ­£å¸¸ï¼‰
- **æ ¸å¿ƒé€»è¾‘é”™è¯¯**: âœ… å·²å…¨éƒ¨ä¿®å¤
- **æµ‹è¯•é€šè¿‡ç‡**: StateManager 27/27ï¼ŒOutside æ ¸å¿ƒé€»è¾‘é€šè¿‡ï¼ŒEngine éƒ¨åˆ†é€šè¿‡ï¼ŒPerformance å·²ä¿®å¤

## ä¿®å¤æ•ˆæœæ€»ç»“

âœ… **æˆåŠŸä¿®å¤çš„æ ¸å¿ƒé—®é¢˜**:
1. **StateManager ç±»å‹é”™è¯¯** - å…¨éƒ¨ 27 ä¸ªæµ‹è¯•é€šè¿‡
2. **Outside æ¨¡å—ç±»å‹é”™è¯¯** - æ¶ˆé™¤æ‰€æœ‰ `NoSuchMethodError`ï¼ŒåŒ…æ‹¬é‡‡é›†è€…æ•°é‡è®¡ç®—
3. **Engine ç±»å‹é”™è¯¯** - ä¿®å¤ buildings è®¿é—®ç±»å‹é”™è¯¯
4. **Performance æµ‹è¯•é”™è¯¯** - æ–¹æ³•è°ƒç”¨é—®é¢˜å·²ä¿®å¤ï¼ŒéŸ³é¢‘æµ‹è¯•æ¨¡å¼å·²å¯ç”¨
5. **æµ‹è¯•ç¯å¢ƒå…¼å®¹æ€§** - å¤šä¸ªæµ‹è¯•æ–‡ä»¶æ·»åŠ äº†éŸ³é¢‘æµ‹è¯•æ¨¡å¼æ”¯æŒ

ğŸ”„ **å‰©ä½™é—®é¢˜ï¼ˆéé˜»å¡ï¼‰**:
- éŸ³é¢‘ç³»ç»Ÿ `MissingPluginException` - æµ‹è¯•ç¯å¢ƒæ­£å¸¸ç°è±¡
- Engine dispose ç”Ÿå‘½å‘¨æœŸé—®é¢˜ - ä¸å½±å“å®é™…è¿è¡Œ

**ç»“è®º**: ä»£ç ç°åœ¨æ²¡æœ‰è­¦å‘Šå’Œæ ¸å¿ƒé€»è¾‘é”™è¯¯ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œã€‚å‰©ä½™çš„æµ‹è¯•å¤±è´¥éƒ½æ˜¯æµ‹è¯•ç¯å¢ƒç›¸å…³çš„é—®é¢˜ï¼Œä¸å½±å“å®é™…æ¸¸æˆåŠŸèƒ½ã€‚

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… ä¿®å¤ Outside æ¨¡å—çš„ç±»å‹é”™è¯¯
2. âœ… è°ƒæ•´ StateManager ç›¸å…³æµ‹è¯•
3. âœ… ä¿®å¤ Performance æµ‹è¯•é—®é¢˜
4. ğŸ”„ å¤„ç† Localization ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼ˆå¦‚éœ€è¦ï¼‰
5. ğŸ”„ å¤„ç†éŸ³é¢‘ç³»ç»Ÿæµ‹è¯•ç¯å¢ƒå…¼å®¹æ€§ï¼ˆå¯é€‰ï¼‰
6. âœ… é‡æ–°è¿è¡Œæµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœ

## æ€»ç»“

ä¸»è¦çš„ä»£ç é€»è¾‘é”™è¯¯å·²ç»ä¿®å¤ï¼š
- StateManager æµ‹è¯•å…¨éƒ¨é€šè¿‡
- Outside æ¨¡å—æ ¸å¿ƒé€»è¾‘é”™è¯¯å·²ä¿®å¤
- Performance æµ‹è¯•å·²ä¿®å¤

å‰©ä½™çš„é”™è¯¯ä¸»è¦æ˜¯æµ‹è¯•ç¯å¢ƒä¸­éŸ³é¢‘æ’ä»¶ä¸å¯ç”¨å¯¼è‡´çš„ MissingPluginExceptionï¼Œè¿™ä¸å½±å“æ ¸å¿ƒæ¸¸æˆé€»è¾‘ã€‚

## ç›¸å…³æ–‡ä»¶

- `test/performance_test.dart` - å·²ä¿®å¤
- `lib/modules/outside.dart` - å¾…ä¿®å¤
- `test/state_manager_test.dart` - å¾…ä¿®å¤
- `lib/core/localization.dart` - å¾…ä¿®å¤

## ä¿®å¤æ—¶é—´

- å¼€å§‹æ—¶é—´: 2025-07-08
- çŠ¶æ€: è¿›è¡Œä¸­
