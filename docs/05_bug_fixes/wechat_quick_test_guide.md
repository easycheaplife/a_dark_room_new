# 微信内嵌Flutter Web快速测试指南

## 立即可行的测试方案

### 方案1: 微信开发者工具测试（推荐）

#### 步骤1: 配置微信开发者工具
1. 打开微信开发者工具
2. 打开您的小程序项目
3. 点击右上角"详情"
4. 在"本地设置"中勾选：
   - ✅ "不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
   - ✅ "不校验 HTTPS 证书"

#### 步骤2: 构建优化版本
```bash
# 在项目根目录执行
./scripts/build_for_wechat.sh

# 或者手动构建
flutter build web --web-renderer html --release
```

#### 步骤3: 部署到服务器
将 `build/web` 目录部署到您的服务器 `https://8.140.248.32/`

#### 步骤4: 测试
1. 在微信开发者工具中运行小程序
2. 进入游戏页面
3. 查看控制台日志，应该看到：
   ```
   🔥 检测到微信环境，应用兼容性配置
   ✅ 已切换到HTML渲染器 for 微信环境
   ✅ 已禁用Service Worker for 微信环境
   ```

### 方案2: 真机测试

#### 前提条件
- 需要有合法域名和HTTPS证书
- 域名已在微信小程序后台配置

#### 步骤
1. 申请域名（如：adarkroom.yourdomain.com）
2. 配置HTTPS证书
3. 在微信小程序后台添加业务域名
4. 修改 `wechat_miniprogram/config/env.js`：
   ```javascript
   h5Url: 'https://adarkroom.yourdomain.com/'
   ```
5. 重新构建和部署

## 预期结果

### 成功的标志
- ✅ 不再出现白屏
- ✅ 能看到游戏界面
- ✅ 控制台显示微信兼容性配置日志
- ✅ 游戏功能正常

### 可能的问题和解决方案

#### 问题1: 仍然白屏
**可能原因**: 域名仍未配置或证书问题
**解决方案**: 
1. 确认在微信开发者工具中关闭了域名校验
2. 检查服务器是否正常运行
3. 查看控制台错误信息

#### 问题2: 加载缓慢
**可能原因**: 资源文件较大
**解决方案**:
1. 使用 `--release` 模式构建
2. 启用服务器压缩
3. 使用CDN加速

#### 问题3: 功能异常
**可能原因**: 微信环境限制
**解决方案**:
1. 查看控制台错误日志
2. 检查音频播放是否正常
3. 测试数据保存功能

## 调试技巧

### 1. 查看详细日志
在微信开发者工具控制台中查看：
```javascript
// 检查微信环境检测结果
console.log(window.WeChatCompatibility);

// 检查Flutter配置
console.log(window._flutter);
```

### 2. 手动测试渲染器
```javascript
// 在控制台执行，检查当前渲染器
console.log('当前渲染器:', window._flutter?.buildConfig?.builds?.[0]?.renderer);
```

### 3. 检查错误上报
小程序端应该能收到详细的错误信息，在 `pages/game/game.js` 的 `onH5Message` 中查看。

## 常见错误代码

| 错误类型 | 描述 | 解决方案 |
|---------|------|----------|
| `domain not in domain list` | 域名不在白名单 | 添加业务域名或关闭校验 |
| `ssl handshake error` | SSL证书问题 | 检查证书有效性 |
| `ERR_CONNECTION_REFUSED` | 连接被拒绝 | 检查服务器状态 |
| `Loading timeout` | 加载超时 | 检查网络和资源大小 |

## 下一步计划

### 短期（立即执行）
1. ✅ 在微信开发者工具中测试（关闭域名校验）
2. ✅ 验证HTML渲染器是否工作
3. ✅ 检查基本游戏功能

### 中期（1-2天内）
1. 申请合法域名
2. 配置HTTPS证书
3. 在微信小程序后台添加业务域名
4. 真机测试

### 长期（持续优化）
1. 性能优化
2. 用户体验改进
3. 错误监控和上报

## 联系支持

如果测试过程中遇到问题：
1. 查看 `docs/05_bug_fixes/wechat_webview_white_screen_fix.md`
2. 检查控制台错误日志
3. 提供详细的错误信息和环境描述

---

**重要提醒**: 微信小程序的域名限制是导致白屏的主要原因。在开发阶段可以通过关闭域名校验来测试，但正式发布必须使用合法域名。
