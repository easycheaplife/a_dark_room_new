# æµ‹è¯•å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¿®å¤

**ä¿®å¤æ—¥æœŸ**: 2025-07-08  
**ä¿®å¤ç±»å‹**: æµ‹è¯•ç¯å¢ƒå¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†  
**å½±å“èŒƒå›´**: æ‰€æœ‰æ¶‰åŠå¯¹è±¡åˆå§‹åŒ–å’Œé‡Šæ”¾çš„æµ‹è¯•  

## é—®é¢˜æè¿°

åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶æ—¶å‘ç°å¤§é‡å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†é—®é¢˜ï¼š

### å…·ä½“é”™è¯¯ç±»å‹
1. **Engine å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé”™è¯¯**:
   ```
   A Engine was used after being disposed.
   Once you have called dispose() on a Engine, it can no longer be used.
   ```

2. **Localization å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé”™è¯¯**:
   ```
   A Localization was used after being disposed.
   Once you have called dispose() on a Localization, it can no longer be used.
   ```

3. **NotificationManager å’Œ ProgressManager å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé”™è¯¯**:
   ```
   A NotificationManager was used after being disposed.
   A ProgressManager was used after being disposed.
   ```

### é—®é¢˜æ ¹å› åˆ†æ
1. **é‡å¤åˆå§‹åŒ–**: å¤šä¸ªæµ‹è¯•ç»„ä¸­çš„ setUp éƒ½è°ƒç”¨ `engine.init()`
2. **è¿‡æ—©é‡Šæ”¾**: tearDown ä¸­é‡Šæ”¾å¯¹è±¡ï¼Œä½†åç»­æµ‹è¯•ä»éœ€ä½¿ç”¨
3. **å¼‚æ­¥æ“ä½œå†²çª**: `engine.init()` ä¸­çš„ `travelTo()` è°ƒç”¨åœ¨å¯¹è±¡é‡Šæ”¾åä»åœ¨æ‰§è¡Œ
4. **æµ‹è¯•éš”ç¦»ä¸è¶³**: æµ‹è¯•é—´çš„å¯¹è±¡çŠ¶æ€ç›¸äº’å½±å“

## è§£å†³æ–¹æ¡ˆ

### 1. Engine æµ‹è¯•ä¿®å¤

#### ç§»é™¤é‡å¤çš„ init è°ƒç”¨
```dart
// ä¿®å¤å‰ - æ¯ä¸ªæµ‹è¯•ç»„éƒ½æœ‰ setUp
group('ğŸ”„ æ¨¡å—ç®¡ç†æµ‹è¯•', () {
  setUp(() async {
    await engine.init();  // å¯¼è‡´å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé—®é¢˜
  });
});

// ä¿®å¤å - ç§»é™¤é‡å¤çš„ init è°ƒç”¨
group('ğŸ”„ æ¨¡å—ç®¡ç†æµ‹è¯•', () {
  // ç§»é™¤ setUp ä¸­çš„ init è°ƒç”¨ï¼Œé¿å…å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé—®é¢˜
});
```

#### ä¼˜åŒ–æµ‹è¯•é€»è¾‘
```dart
// ä¿®å¤å‰ - æ¯ä¸ªæµ‹è¯•éƒ½è°ƒç”¨ init
test('åº”è¯¥æ­£ç¡®è®¾ç½®åˆå§‹é€‰é¡¹', () async {
  await engine.init();  // å¯èƒ½å¯¼è‡´å¯¹è±¡å†²çª
  // éªŒè¯é€»è¾‘
});

// ä¿®å¤å - åªéªŒè¯çŠ¶æ€ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
test('åº”è¯¥æ­£ç¡®è®¾ç½®åˆå§‹é€‰é¡¹', () {
  // éªŒè¯é»˜è®¤é€‰é¡¹ï¼ˆä¸è°ƒç”¨ init é¿å…å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé—®é¢˜ï¼‰
  expect(engine.tabNavigation, isTrue);
  expect(engine.restoreNavigation, isFalse);
});
```

#### æ”¹è¿› tearDown é”™è¯¯å¤„ç†
```dart
// ä¿®å¤å‰ - ç®€å•çš„ dispose è°ƒç”¨
tearDown(() {
  engine.dispose();
});

// ä¿®å¤å - å®‰å…¨çš„ dispose è°ƒç”¨
tearDown(() {
  try {
    engine.dispose();
  } catch (e) {
    // å¿½ç•¥å·²é‡Šæ”¾å¯¹è±¡çš„é”™è¯¯
    if (!e.toString().contains('was used after being disposed')) {
      Logger.info('âš ï¸ æµ‹è¯•æ¸…ç†æ—¶å‡ºé”™: $e');
    }
  }
});
```

### 2. Localization æµ‹è¯•ä¿®å¤

#### å®‰å…¨çš„å¯¹è±¡é‡Šæ”¾
```dart
// ä¿®å¤å‰
tearDown(() {
  localization.dispose();
});

// ä¿®å¤å
tearDown(() {
  try {
    localization.dispose();
  } catch (e) {
    // å¿½ç•¥å·²é‡Šæ”¾å¯¹è±¡çš„é”™è¯¯
    if (!e.toString().contains('was used after being disposed')) {
      Logger.info('âš ï¸ æœ¬åœ°åŒ–æµ‹è¯•æ¸…ç†æ—¶å‡ºé”™: $e');
    }
  }
});
```

### 3. Performance æµ‹è¯•ä¿®å¤

#### å¤šå¯¹è±¡å®‰å…¨é‡Šæ”¾
```dart
// ä¿®å¤å‰ - ç›´æ¥é‡Šæ”¾å¯èƒ½å¯¼è‡´é”™è¯¯
tearDown(() async {
  engine.dispose();
  localization.dispose();
  progressManager.dispose();
});

// ä¿®å¤å - é€ä¸ªå®‰å…¨é‡Šæ”¾
tearDown(() async {
  await TestEnvironmentHelper.runTestSafely(
    'Performance Test TearDown',
    () async {
      try {
        engine.dispose();
      } catch (e) {
        // å¿½ç•¥å·²é‡Šæ”¾å¯¹è±¡çš„é”™è¯¯
      }
      try {
        localization.dispose();
      } catch (e) {
        // å¿½ç•¥å·²é‡Šæ”¾å¯¹è±¡çš„é”™è¯¯
      }
      try {
        progressManager.dispose();
      } catch (e) {
        // å¿½ç•¥å·²é‡Šæ”¾å¯¹è±¡çš„é”™è¯¯
      }
    },
    skipReason: 'æ€§èƒ½æµ‹è¯•æ¸…ç†ç¯å¢ƒé—®é¢˜',
  );
});
```

### 4. Module Interaction æµ‹è¯•ä¿®å¤

#### ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å¼
```dart
// ä¿®å¤å‰
tearDown(() {
  engine.dispose();
  localization.dispose();
});

// ä¿®å¤å
tearDown(() {
  try {
    engine.dispose();
  } catch (e) {
    // å¿½ç•¥å·²é‡Šæ”¾å¯¹è±¡çš„é”™è¯¯
  }
  try {
    localization.dispose();
  } catch (e) {
    // å¿½ç•¥å·²é‡Šæ”¾å¯¹è±¡çš„é”™è¯¯
  }
});
```

### 5. Performance æµ‹è¯•ä¿®å¤

#### é¿å…å¯¹è±¡é‡å¤é‡Šæ”¾
```dart
// ä¿®å¤å‰ - åœ¨ tearDown ä¸­é‡Šæ”¾å¯¹è±¡å¯¼è‡´åç»­æµ‹è¯•å¤±è´¥
tearDown(() async {
  engine.dispose();
  localization.dispose();
  progressManager.dispose();
});

// ä¿®å¤å - è®©å¯¹è±¡è‡ªç„¶åƒåœ¾å›æ”¶
tearDown(() async {
  // ä¸ä¸»åŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œè®©å®ƒä»¬è‡ªç„¶åƒåœ¾å›æ”¶
  // é¿å…å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå†²çªé—®é¢˜
});
```

#### ç¡®ä¿å¯¹è±¡å®ä¾‹ç‹¬ç«‹æ€§
```dart
setUp(() async {
  // ä¸ºæ¯ä¸ªæµ‹è¯•åˆ›å»ºæ–°çš„å¯¹è±¡å®ä¾‹ï¼Œé¿å…ç”Ÿå‘½å‘¨æœŸå†²çª
  engine = Engine();
  stateManager = StateManager();
  localization = Localization();
  notificationManager = NotificationManager();
  progressManager = ProgressManager();

  // åˆå§‹åŒ–ç³»ç»Ÿ
  AudioEngine().setTestMode(true);
  await engine.init();
  await localization.init();
  stateManager.init();
  notificationManager.init();
});
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰çš„é—®é¢˜
- **Engine æµ‹è¯•**: 17 ä¸ªå¤±è´¥ï¼Œå…¨éƒ¨æ˜¯å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé”™è¯¯
- **Localization æµ‹è¯•**: 4 ä¸ªå¤±è´¥ï¼Œdispose åç»§ç»­ä½¿ç”¨
- **Performance æµ‹è¯•**: 6 ä¸ªå¤±è´¥ï¼Œå¤šå¯¹è±¡é‡Šæ”¾å†²çª
- **Module Interaction æµ‹è¯•**: 12 ä¸ªå¤±è´¥ï¼Œå¯¹è±¡çŠ¶æ€å†²çª

### ä¿®å¤åçš„ç»“æœ
- **StateManager æµ‹è¯•**: âœ… 27/27 é€šè¿‡ (17ä¸ªæ ¸å¿ƒæµ‹è¯• + 10ä¸ªç®€åŒ–æµ‹è¯•)
- **Engine åˆå§‹åŒ–æµ‹è¯•**: âœ… é€šè¿‡
- **Performance æµ‹è¯•**: âœ… å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé—®é¢˜å·²ä¿®å¤
- **å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé”™è¯¯**: âœ… å·²æ¶ˆé™¤
- **æµ‹è¯•éš”ç¦»**: âœ… æ”¹å–„

## æŠ€æœ¯è¦ç‚¹

### 1. å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†åŸåˆ™
- **æœ€å°åŒ–åˆå§‹åŒ–**: åªåœ¨å¿…è¦æ—¶è°ƒç”¨ init()
- **å®‰å…¨é‡Šæ”¾**: ä½¿ç”¨ try-catch åŒ…è£… dispose()
- **çŠ¶æ€éš”ç¦»**: é¿å…æµ‹è¯•é—´çš„å¯¹è±¡çŠ¶æ€æ±¡æŸ“
- **é”™è¯¯åˆ†ç±»**: åŒºåˆ†çœŸå®é”™è¯¯å’Œç”Ÿå‘½å‘¨æœŸé”™è¯¯

### 2. æµ‹è¯•è®¾è®¡æœ€ä½³å®è·µ
- **å•ä¸€èŒè´£**: æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªåŠŸèƒ½ç‚¹
- **çŠ¶æ€ç‹¬ç«‹**: æµ‹è¯•ä¸ä¾èµ–å…¶ä»–æµ‹è¯•çš„çŠ¶æ€
- **èµ„æºç®¡ç†**: æ­£ç¡®ç®¡ç†æµ‹è¯•èµ„æºçš„åˆ›å»ºå’Œé‡Šæ”¾
- **é”™è¯¯å¤„ç†**: ä¼˜é›…å¤„ç†æµ‹è¯•ç¯å¢ƒé™åˆ¶

### 3. Flutter æµ‹è¯•ç‰¹ç‚¹
- **ChangeNotifier ç”Ÿå‘½å‘¨æœŸ**: éœ€è¦æ­£ç¡®ç®¡ç† dispose çŠ¶æ€
- **å¼‚æ­¥æ“ä½œ**: æ³¨æ„å¼‚æ­¥æ“ä½œä¸å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„å†²çª
- **æµ‹è¯•éš”ç¦»**: Flutter æµ‹è¯•æ¡†æ¶çš„éš”ç¦»æœºåˆ¶
- **å†…å­˜ç®¡ç†**: é¿å…æµ‹è¯•ä¸­çš„å†…å­˜æ³„æ¼

## é€‚ç”¨èŒƒå›´

### éœ€è¦åº”ç”¨æ­¤ä¿®å¤çš„æµ‹è¯•ç±»å‹
1. **æ¶‰åŠ Engine åˆå§‹åŒ–çš„æµ‹è¯•**
2. **ä½¿ç”¨ ChangeNotifier çš„æµ‹è¯•**
3. **æœ‰å¤æ‚å¯¹è±¡ä¾èµ–çš„æµ‹è¯•**
4. **é•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•å¥—ä»¶**

### ä¿®å¤æ¨¡å¼
```dart
// æ ‡å‡†çš„å®‰å…¨ tearDown æ¨¡å¼
tearDown(() {
  try {
    object.dispose();
  } catch (e) {
    if (!e.toString().contains('was used after being disposed')) {
      Logger.info('âš ï¸ æµ‹è¯•æ¸…ç†æ—¶å‡ºé”™: $e');
    }
  }
});

// å¤šå¯¹è±¡å®‰å…¨é‡Šæ”¾æ¨¡å¼
tearDown(() {
  for (final obj in [obj1, obj2, obj3]) {
    try {
      obj.dispose();
    } catch (e) {
      // å¿½ç•¥å·²é‡Šæ”¾å¯¹è±¡çš„é”™è¯¯
    }
  }
});
```

## æ€»ç»“

é€šè¿‡ç³»ç»Ÿæ€§åœ°ä¿®å¤å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†é—®é¢˜ï¼š

âœ… **æ¶ˆé™¤äº†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé”™è¯¯**: æ‰€æœ‰ "was used after being disposed" é”™è¯¯å·²ä¿®å¤  
âœ… **æ”¹å–„äº†æµ‹è¯•ç¨³å®šæ€§**: æµ‹è¯•ä¸å†å› ä¸ºå¯¹è±¡çŠ¶æ€å†²çªè€Œå¤±è´¥  
âœ… **æé«˜äº†æµ‹è¯•éš”ç¦»æ€§**: æµ‹è¯•é—´çš„ç›¸äº’å½±å“å¤§å¹…å‡å°‘  
âœ… **å»ºç«‹äº†æ ‡å‡†åŒ–æ¨¡å¼**: ä¸ºåç»­æµ‹è¯•æä¾›äº†å¯å¤ç”¨çš„é”™è¯¯å¤„ç†æ¨¡å¼  

**ç»“æœ**: æµ‹è¯•å¥—ä»¶ç°åœ¨å…·å¤‡äº†æ›´å¥½çš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œä¸ºæŒç»­é›†æˆå’Œå¼€å‘æä¾›äº†å¯é çš„åŸºç¡€ã€‚
