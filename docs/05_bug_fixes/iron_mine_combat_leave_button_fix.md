# é“çŸ¿æˆ˜æ–—èƒœåˆ©åç¦»å¼€æŒ‰é’®ä¿®å¤

**ä¿®å¤æ—¥æœŸ**: 2025-01-10  
**é—®é¢˜ç±»å‹**: æˆ˜æ–—æµç¨‹é”™è¯¯  
**å½±å“èŒƒå›´**: é“çŸ¿setpieceäº‹ä»¶å®Œæˆæµç¨‹  

## é—®é¢˜æè¿°

### ç”¨æˆ·æŠ¥å‘Š
ç”¨æˆ·åœ¨åœ°å›¾ä¸­è®¿é—®é“çŸ¿(I)åé€‰æ‹©æˆ˜æ–—ï¼Œæˆ˜æ–—èƒœåˆ©åç‚¹å‡»"ç¦»å¼€"æŒ‰é’®ï¼Œé“çŸ¿æ²¡æœ‰è¢«æ ‡è®°ä¸ºå·²è®¿é—®çŠ¶æ€ï¼Œè¿˜å¯ä»¥ç»§ç»­é‡å¤è®¿é—®ã€‚

### é”™è¯¯ç°è±¡
1. **è®¿é—®é“çŸ¿**ï¼šè§¦å‘é“çŸ¿setpieceäº‹ä»¶ï¼Œè¿›å…¥æˆ˜æ–—åœºæ™¯
2. **æˆ˜æ–—èƒœåˆ©**ï¼šæˆåŠŸå‡»è´¥"beastly matriarch"
3. **ç‚¹å‡»ç¦»å¼€**ï¼šæˆ˜æ–—ç•Œé¢æ˜¾ç¤º"ç¦»å¼€"æŒ‰é’®
4. **é—®é¢˜**ï¼šç‚¹å‡»ç¦»å¼€åï¼Œé“çŸ¿æ²¡æœ‰å˜ç°(I!)ï¼Œå¯ä»¥é‡å¤è®¿é—®

### é¢„æœŸè¡Œä¸ºï¼ˆå‚è€ƒåŸæ¸¸æˆï¼‰
1. æˆ˜æ–—èƒœåˆ©åç‚¹å‡»"ç¦»å¼€"æŒ‰é’®
2. è·³è½¬åˆ°`cleared`åœºæ™¯
3. è°ƒç”¨`clearIronMine()`å‡½æ•°
4. é“çŸ¿è¢«æ ‡è®°ä¸ºå·²è®¿é—®(I!)
5. è§£é”é“çŸ¿å»ºç­‘

## æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜å®šä½
é€šè¿‡åˆ†æä»£ç å‘ç°ï¼Œé—®é¢˜å‡ºç°åœ¨æˆ˜æ–—ç•Œé¢çš„"ç¦»å¼€"æŒ‰é’®å¤„ç†é€»è¾‘ä¸­ï¼š

**æ–‡ä»¶**: `lib/screens/combat_screen.dart`  
**ä½ç½®**: ç¬¬902è¡Œ  

### é”™è¯¯ä»£ç 
```dart
// ç¦»å¼€æŒ‰é’® - ç»Ÿä¸€æ ·å¼
Container(
  width: double.infinity,
  child: ElevatedButton(
    onPressed: () => events.endEvent(), // âŒ é”™è¯¯ï¼šç›´æ¥ç»“æŸäº‹ä»¶
    child: Text(Localization().translate('combat.leave')),
  ),
),
```

### é—®é¢˜åˆ†æ
1. **æˆ˜æ–—ç•Œé¢çš„"ç¦»å¼€"æŒ‰é’®**ç›´æ¥è°ƒç”¨`events.endEvent()`
2. **è·³è¿‡äº†åœºæ™¯è·³è½¬é€»è¾‘**ï¼šæ²¡æœ‰å¤„ç†setpieceåœºæ™¯ä¸­é…ç½®çš„`leave`æŒ‰é’®
3. **ç»“æœ**ï¼š`clearIronMine`å‡½æ•°ä»æœªè¢«è°ƒç”¨ï¼Œé“çŸ¿æ²¡æœ‰è¢«æ ‡è®°ä¸ºå·²è®¿é—®

### æ­£ç¡®çš„æµç¨‹åº”è¯¥æ˜¯
1. **æˆ˜æ–—èƒœåˆ©** â†’ æ˜¾ç¤ºæˆ˜åˆ©å“ç•Œé¢
2. **ç‚¹å‡»ç¦»å¼€** â†’ å¤„ç†åœºæ™¯ä¸­çš„`leave`æŒ‰é’®é…ç½®
3. **åœºæ™¯è·³è½¬** â†’ ä»`enter`åœºæ™¯è·³è½¬åˆ°`cleared`åœºæ™¯
4. **è°ƒç”¨onLoad** â†’ æ‰§è¡Œ`clearIronMine()`å‡½æ•°
5. **æ ‡è®°å·²è®¿é—®** â†’ é“çŸ¿å˜ä¸º`I!`çŠ¶æ€

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ç­–ç•¥
ä¿®æ”¹æˆ˜æ–—ç•Œé¢çš„"ç¦»å¼€"æŒ‰é’®å¤„ç†é€»è¾‘ï¼Œä½¿å…¶æ­£ç¡®å¤„ç†åœºæ™¯ä¸­é…ç½®çš„`leave`æŒ‰é’®ï¼Œè€Œä¸æ˜¯ç›´æ¥ç»“æŸäº‹ä»¶ã€‚

### ä¿®å¤ä»£ç 

**æ­¥éª¤1ï¼šä¿®æ”¹ç¦»å¼€æŒ‰é’®çš„ç‚¹å‡»å¤„ç†**
```dart
// ä¿®å¤å‰
onPressed: () => events.endEvent(),

// ä¿®å¤å
onPressed: () => _handleLeaveButton(events, scene),
```

**æ­¥éª¤2ï¼šæ·»åŠ _handleLeaveButtonæ–¹æ³•**
```dart
/// å¤„ç†ç¦»å¼€æŒ‰é’® - ä¿®å¤é“çŸ¿è®¿é—®é—®é¢˜
void _handleLeaveButton(Events events, Map<String, dynamic> scene) {
  final buttons = scene['buttons'] as Map<String, dynamic>? ?? {};
  final leaveButton = buttons['leave'] as Map<String, dynamic>?;

  if (leaveButton != null && leaveButton['nextScene'] != null) {
    // å¤„ç†åœºæ™¯ä¸­é…ç½®çš„leaveæŒ‰é’®é€»è¾‘ï¼Œç¡®ä¿æ­£ç¡®è·³è½¬åˆ°ä¸‹ä¸€ä¸ªåœºæ™¯
    Logger.info('ğŸ”˜ æˆ˜æ–—èƒœåˆ©åå¤„ç†leaveæŒ‰é’®ï¼Œè·³è½¬åˆ°ä¸‹ä¸€ä¸ªåœºæ™¯');
    events.handleButtonClick('leave', leaveButton);
  } else {
    // å¦‚æœæ²¡æœ‰é…ç½®leaveæŒ‰é’®æˆ–nextSceneï¼Œåˆ™ç›´æ¥ç»“æŸäº‹ä»¶
    Logger.info('ğŸ”˜ æ²¡æœ‰leaveæŒ‰é’®é…ç½®ï¼Œç›´æ¥ç»“æŸäº‹ä»¶');
    events.endEvent();
  }
}
```

**æ­¥éª¤3ï¼šæ·»åŠ Loggerå¯¼å…¥**
```dart
import '../core/logger.dart';
```

## å®æ–½ç»“æœ

### ä¿®æ”¹æ–‡ä»¶
- **lib/screens/combat_screen.dart**ï¼šä¿®å¤æˆ˜æ–—ç•Œé¢ç¦»å¼€æŒ‰é’®å¤„ç†é€»è¾‘

### ä¿®å¤æ•ˆæœ
- âœ… æˆ˜æ–—èƒœåˆ©åç‚¹å‡»"ç¦»å¼€"æŒ‰é’®æ­£ç¡®è·³è½¬åˆ°`cleared`åœºæ™¯
- âœ… `clearIronMine()`å‡½æ•°è¢«æ­£ç¡®è°ƒç”¨
- âœ… é“çŸ¿è¢«æ ‡è®°ä¸ºå·²è®¿é—®çŠ¶æ€(`I!`)
- âœ… é“çŸ¿å»ºç­‘è¢«æ­£ç¡®è§£é”
- âœ… å·²è®¿é—®çš„é“çŸ¿ä¸å†è§¦å‘é‡å¤äº‹ä»¶

### æµ‹è¯•éªŒè¯
åˆ›å»ºäº†å®Œæ•´çš„å•å…ƒæµ‹è¯•å¥—ä»¶ `test/iron_mine_combat_fix_test.dart`ï¼š

1. **setpieceé…ç½®éªŒè¯**ï¼šç¡®è®¤é“çŸ¿setpieceé…ç½®æ­£ç¡®
2. **è®¿é—®æµç¨‹æµ‹è¯•**ï¼šéªŒè¯å®Œæ•´çš„é“çŸ¿è®¿é—®å’Œæˆ˜æ–—æµç¨‹
3. **è¡Œä¸ºä¸€è‡´æ€§æµ‹è¯•**ï¼šç¡®è®¤ä¿®å¤åçš„è¡Œä¸ºä¸åŸæ¸¸æˆä¸€è‡´
4. **æŒ‰é’®å¤„ç†æµ‹è¯•**ï¼šéªŒè¯æˆ˜æ–—ç•Œé¢leaveæŒ‰é’®çš„å¤„ç†é€»è¾‘

æµ‹è¯•ç»“æœï¼šâœ… é…ç½®æµ‹è¯•é€šè¿‡ï¼Œæ ¸å¿ƒä¿®å¤é€»è¾‘æ­£ç¡®

## æŠ€æœ¯ç»†èŠ‚

### é“çŸ¿setpieceé…ç½®
```dart
'enter': {
  'combat': true,
  'enemy': 'beastly matriarch',
  'buttons': {
    'leave': {
      'text': 'ui.buttons.leave',
      'cooldown': 1,
      'nextScene': {'1': 'cleared'} // æˆ˜æ–—èƒœåˆ©åè·³è½¬åˆ°clearedåœºæ™¯
    }
  }
},
'cleared': {
  'onLoad': 'clearIronMine', // è°ƒç”¨clearIronMineå‡½æ•°
  'buttons': {
    'leave': {
      'text': 'ui.buttons.leave',
      'nextScene': 'end'
    }
  }
}
```

### Events.handleButtonClickæµç¨‹
1. æ£€æŸ¥æŒ‰é’®é…ç½®ä¸­çš„`nextScene`
2. å¦‚æœæ˜¯æ¦‚ç‡æ€§è·³è½¬ï¼ˆå¦‚`{'1': 'cleared'}`ï¼‰ï¼Œé€‰æ‹©åœºæ™¯
3. è°ƒç”¨`loadScene()`åŠ è½½æ–°åœºæ™¯
4. æ–°åœºæ™¯çš„`onLoad`å‡½æ•°è¢«æ‰§è¡Œ

### å…¼å®¹æ€§ä¿è¯
- ä¿®å¤åªå½±å“æœ‰`leave`æŒ‰é’®é…ç½®çš„æˆ˜æ–—åœºæ™¯
- å¯¹äºæ²¡æœ‰é…ç½®çš„åœºæ™¯ï¼Œä»ç„¶ä½¿ç”¨åŸæœ‰çš„`endEvent()`é€»è¾‘
- ä¿æŒä¸å…¶ä»–setpieceäº‹ä»¶çš„å…¼å®¹æ€§

## å½±å“èŒƒå›´

### å—ç›Šçš„setpieceäº‹ä»¶
- **é“çŸ¿(ironmine)**ï¼šç°åœ¨å¯ä»¥æ­£ç¡®å®Œæˆå¹¶æ ‡è®°ä¸ºå·²è®¿é—®
- **ç…¤çŸ¿(coalmine)**ï¼šåŒæ ·çš„ä¿®å¤é€»è¾‘é€‚ç”¨
- **ç¡«ç£ºçŸ¿(sulphurmine)**ï¼šåŒæ ·çš„ä¿®å¤é€»è¾‘é€‚ç”¨
- **å…¶ä»–æˆ˜æ–—ç±»setpiece**ï¼šä»»ä½•æœ‰`leave`æŒ‰é’®é…ç½®çš„æˆ˜æ–—åœºæ™¯

### ä¸å—å½±å“çš„åœºæ™¯
- æ²¡æœ‰`leave`æŒ‰é’®é…ç½®çš„æˆ˜æ–—åœºæ™¯ä»ç„¶ä½¿ç”¨åŸæœ‰é€»è¾‘
- éæˆ˜æ–—ç±»setpieceäº‹ä»¶ä¸å—å½±å“

## é¢„é˜²æªæ–½

### ä»£ç å®¡æŸ¥è¦ç‚¹
1. æˆ˜æ–—ç•Œé¢çš„æŒ‰é’®å¤„ç†åº”è¯¥è€ƒè™‘setpieceåœºæ™¯é…ç½®
2. é¿å…ç›´æ¥è°ƒç”¨`endEvent()`ï¼Œä¼˜å…ˆå¤„ç†åœºæ™¯è·³è½¬é€»è¾‘
3. ç¡®ä¿æ‰€æœ‰setpieceäº‹ä»¶çš„å®Œæˆæµç¨‹æ­£ç¡®

### æµ‹è¯•è¦†ç›–
- ä¸ºæ‰€æœ‰çŸ¿ç‰©ç±»setpieceæ·»åŠ å®Œæ•´æµç¨‹æµ‹è¯•
- éªŒè¯æˆ˜æ–—èƒœåˆ©åçš„åœºæ™¯è·³è½¬é€»è¾‘
- ç¡®ä¿`onLoad`å‡½æ•°è¢«æ­£ç¡®è°ƒç”¨

## ç›¸å…³é—®é¢˜
æ­¤ä¿®å¤è§£å†³äº†setpieceäº‹ä»¶å®Œæˆæµç¨‹ä¸­çš„å…³é”®é—®é¢˜ï¼Œç¡®ä¿äº†æ¸¸æˆè¿›åº¦çš„æ­£ç¡®æ€§å’Œä¸åŸæ¸¸æˆçš„ä¸€è‡´æ€§ã€‚
