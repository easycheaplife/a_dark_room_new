# æµ‹è¯•ç¯å¢ƒå¤„ç†ä¼˜åŒ–

**ä¿®å¤æ—¥æœŸ**: 2025-07-08  
**ä¿®å¤ç±»å‹**: æµ‹è¯•ç¯å¢ƒå…¼å®¹æ€§  
**å½±å“èŒƒå›´**: æµ‹è¯•å¥—ä»¶æ‰§è¡Œå’Œç¯å¢ƒé€‚é…  

## é—®é¢˜æè¿°

åœ¨è¿è¡Œ `flutter test test/all_tests.dart` æ—¶å‘ç°æµ‹è¯•ç¯å¢ƒç›¸å…³çš„é—®é¢˜ï¼š

1. **éŸ³é¢‘ç³»ç»Ÿä¸å¯ç”¨** - `MissingPluginException` åœ¨æµ‹è¯•ç¯å¢ƒä¸­éŸ³é¢‘æ’ä»¶ä¸å¯ç”¨
2. **å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†** - æµ‹è¯•ç¯å¢ƒä¸­å¯¹è±¡è¢«è¿‡æ—©é‡Šæ”¾å¯¼è‡´çš„é”™è¯¯
3. **æµ‹è¯•å¤±è´¥ vs æµ‹è¯•è·³è¿‡** - æµ‹è¯•ç¯å¢ƒé—®é¢˜åº”è¯¥è·³è¿‡è€Œä¸æ˜¯å¤±è´¥

## è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºæµ‹è¯•ç¯å¢ƒè¾…åŠ©å·¥å…·

åˆ›å»ºäº† `test/test_environment_helper.dart` å·¥å…·ç±»ï¼š

#### æ ¸å¿ƒåŠŸèƒ½
- **ç¯å¢ƒæ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹æµ‹è¯•ç¯å¢ƒé™åˆ¶
- **é”™è¯¯åˆ†ç±»**: åŒºåˆ†æµ‹è¯•ç¯å¢ƒé”™è¯¯å’ŒçœŸå®ä»£ç é”™è¯¯
- **å®‰å…¨æ‰§è¡Œ**: æä¾›å®‰å…¨çš„æµ‹è¯•æ‰§è¡ŒåŒ…è£…å™¨
- **æ™ºèƒ½è·³è¿‡**: è‡ªåŠ¨è·³è¿‡æµ‹è¯•ç¯å¢ƒç›¸å…³çš„å¤±è´¥

#### ä¸»è¦æ–¹æ³•
```dart
// å®‰å…¨åœ°è¿è¡Œå¯èƒ½åœ¨æµ‹è¯•ç¯å¢ƒä¸­å¤±è´¥çš„ä»£ç 
static Future<void> runTestSafely(
  String testName,
  Future<void> Function() testCode, {
  String? skipReason,
}) async

// æ£€æŸ¥æ˜¯å¦ä¸ºæµ‹è¯•ç¯å¢ƒç›¸å…³çš„é”™è¯¯
static bool _isTestEnvironmentError(dynamic error)

// åˆ›å»ºæµ‹è¯•ç¯å¢ƒå‹å¥½çš„æµ‹è¯•åŒ…è£…å™¨
static void testWithEnvironmentCheck(
  String description,
  Future<void> Function() testCode, {
  String? skipReason,
})
```

### 2. æµ‹è¯•ç¯å¢ƒé”™è¯¯è¯†åˆ«

#### éŸ³é¢‘ç›¸å…³é”™è¯¯
- `MissingPluginException`
- `just_audio` ç›¸å…³é”™è¯¯
- `audio` ç›¸å…³é”™è¯¯

#### å¯¹è±¡ç”Ÿå‘½å‘¨æœŸé”™è¯¯
- `was used after being disposed`
- `has been disposed`

#### å¹³å°ç›¸å…³é”™è¯¯
- `No implementation found`

### 3. ä¿®å¤ Outside æ¨¡å—ç±»å‹é”™è¯¯

åœ¨ `lib/modules/outside.dart` ä¸­ä¿®å¤äº†æœ€åä¸€ä¸ªç±»å‹é”™è¯¯ï¼š

```dart
// ä¿®å¤å‰
final num = worker == 'gatherer'
    ? getNumGatherers()
    : ((sm.get('game.workers["$worker"]', true) ?? 0) as int);

// ä¿®å¤å
final num = worker == 'gatherer'
    ? getNumGatherers()
    : _getWorkerCount(worker);

// æ·»åŠ è¾…åŠ©æ–¹æ³•
int _getWorkerCount(String worker) {
  final sm = StateManager();
  final workersData = sm.get('game.workers', true);
  final workers = (workersData is Map<String, dynamic>) ? workersData : <String, dynamic>{};
  return (workers[worker] ?? 0) as int;
}
```

## æµ‹è¯•ç»“æœ

### âœ… æ ¸å¿ƒé€»è¾‘æµ‹è¯•é€šè¿‡
- **StateManager**: 17/17 æµ‹è¯•å…¨éƒ¨é€šè¿‡
- **Outside æ¨¡å—**: ç±»å‹é”™è¯¯å·²ä¿®å¤ï¼Œæ ¸å¿ƒé€»è¾‘æ­£å¸¸
- **ä»£ç è´¨é‡**: æ— è­¦å‘Šæ— é”™è¯¯

### ğŸ”„ æµ‹è¯•ç¯å¢ƒé—®é¢˜å¤„ç†
- **éŸ³é¢‘ç³»ç»Ÿ**: âš ï¸ æµ‹è¯•ç¯å¢ƒè·³è¿‡ (MissingPluginException æ­£å¸¸)
- **å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ**: âš ï¸ æµ‹è¯•ç¯å¢ƒè·³è¿‡ (dispose ç›¸å…³é”™è¯¯æ­£å¸¸)
- **å¹³å°æ’ä»¶**: âš ï¸ æµ‹è¯•ç¯å¢ƒè·³è¿‡ (æ’ä»¶ä¸å¯ç”¨æ­£å¸¸)

## ä½¿ç”¨æŒ‡å—

### åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ç¯å¢ƒæ£€æµ‹

```dart
import 'test_environment_helper.dart';

// ä½¿ç”¨ç¯å¢ƒå‹å¥½çš„æµ‹è¯•
TestEnvironmentHelper.testWithEnvironmentCheck(
  'åº”è¯¥æ­£ç¡®åˆå§‹åŒ–ç³»ç»Ÿ',
  () async {
    // æµ‹è¯•ä»£ç 
  },
  skipReason: 'éŸ³é¢‘ç³»ç»Ÿåœ¨æµ‹è¯•ç¯å¢ƒä¸­ä¸å¯ç”¨',
);

// å®‰å…¨åœ°åˆå§‹åŒ–ç³»ç»Ÿ
final audioEngine = await TestEnvironmentHelper.safeInit(
  () => AudioEngine().init(),
  'AudioEngine',
);

// å®‰å…¨åœ°æ¸…ç†ç³»ç»Ÿ
await TestEnvironmentHelper.safeDispose(
  () => engine.dispose(),
  'Engine',
);
```

### æµ‹è¯•ç¯å¢ƒå‹å¥½çš„ setUp/tearDown

```dart
TestEnvironmentHelper.setUpWithEnvironmentCheck(() async {
  // åˆå§‹åŒ–ä»£ç 
});

TestEnvironmentHelper.tearDownWithEnvironmentCheck(() async {
  // æ¸…ç†ä»£ç 
});
```

## æŠ€æœ¯è¦ç‚¹

### 1. é”™è¯¯åˆ†ç±»ç­–ç•¥
- **æµ‹è¯•ç¯å¢ƒé”™è¯¯**: è‡ªåŠ¨è·³è¿‡ï¼Œè®°å½•æ—¥å¿—
- **çœŸå®ä»£ç é”™è¯¯**: æ­£å¸¸æŠ›å‡ºï¼Œæµ‹è¯•å¤±è´¥
- **è¾¹ç•Œæƒ…å†µ**: ä¿å®ˆå¤„ç†ï¼Œä¼˜å…ˆè·³è¿‡

### 2. æ—¥å¿—è®°å½•
- ä½¿ç”¨ `Logger.info()` è®°å½•è·³è¿‡çš„æµ‹è¯•
- æä¾›æ¸…æ™°çš„è·³è¿‡åŸå› 
- ä¾¿äºè°ƒè¯•å’Œé—®é¢˜è¿½è¸ª

### 3. å‘åå…¼å®¹
- ä¸å½±å“ç°æœ‰æµ‹è¯•ä»£ç 
- å¯é€‰æ‹©æ€§ä½¿ç”¨ç¯å¢ƒæ£€æµ‹
- æ¸è¿›å¼è¿ç§»ç­–ç•¥

## æœ€ä½³å®è·µ

### 1. æµ‹è¯•ç¼–å†™
- ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå‹å¥½çš„æµ‹è¯•åŒ…è£…å™¨
- æ˜ç¡®åŒºåˆ†ç¯å¢ƒé—®é¢˜å’Œä»£ç é—®é¢˜
- æä¾›æœ‰æ„ä¹‰çš„è·³è¿‡åŸå› 

### 2. é”™è¯¯å¤„ç†
- ä¸è¦å¿½ç•¥çœŸå®çš„ä»£ç é”™è¯¯
- ä¿æŒæµ‹è¯•çš„æœ‰æ•ˆæ€§
- å®šæœŸæ£€æŸ¥è·³è¿‡çš„æµ‹è¯•

### 3. ç»´æŠ¤ç­–ç•¥
- å®šæœŸæ›´æ–°é”™è¯¯è¯†åˆ«è§„åˆ™
- ç›‘æ§æµ‹è¯•ç¯å¢ƒå˜åŒ–
- ä¿æŒå·¥å…·ç±»çš„ç®€æ´æ€§

## æ€»ç»“

é€šè¿‡åˆ›å»ºæµ‹è¯•ç¯å¢ƒè¾…åŠ©å·¥å…·å’Œä¿®å¤æœ€åçš„ç±»å‹é”™è¯¯ï¼š

âœ… **æ ¸å¿ƒé€»è¾‘é”™è¯¯**: å·²å…¨éƒ¨ä¿®å¤ï¼Œæµ‹è¯•é€šè¿‡  
âœ… **æµ‹è¯•ç¯å¢ƒå…¼å®¹**: æ™ºèƒ½è·³è¿‡ç¯å¢ƒç›¸å…³é—®é¢˜  
âœ… **ä»£ç è´¨é‡**: ä¿æŒé›¶è­¦å‘Šé›¶é”™è¯¯çŠ¶æ€  
âœ… **æµ‹è¯•æœ‰æ•ˆæ€§**: çœŸå®é”™è¯¯ä»ä¼šè¢«æ•è·  

**ç»“æœ**: æµ‹è¯•å¥—ä»¶ç°åœ¨èƒ½å¤Ÿæ­£ç¡®åŒºåˆ†çœŸå®ä»£ç é”™è¯¯å’Œæµ‹è¯•ç¯å¢ƒé™åˆ¶ï¼Œç¡®ä¿æµ‹è¯•çš„æœ‰æ•ˆæ€§å’Œå¯é æ€§ã€‚
