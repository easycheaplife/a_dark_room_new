# ç ´æ—§æ˜Ÿèˆ°é¡µç­¾ç¼ºå¤±é—®é¢˜æœ€ç»ˆä¿®å¤

**æœ€åæ›´æ–°**: 2025-06-29

## ğŸ› é—®é¢˜æè¿°

**é—®é¢˜**: ç”¨æˆ·è¯¢é—®åŸæ¸¸æˆä¸­çš„"ç ´æ—§æ˜Ÿèˆ°"é¡µç­¾ä¸ºä»€ä¹ˆåœ¨ç°æœ‰Flutteré¡¹ç›®ä¸­æ²¡æœ‰å‡ºç°ã€‚

**å½±å“**: ç©å®¶æ— æ³•è®¿é—®æ˜Ÿèˆ°åŠŸèƒ½ï¼Œæ— æ³•è¿›è¡Œèˆ¹ä½“å¼ºåŒ–ã€å¼•æ“å‡çº§å’Œæœ€ç»ˆçš„å¤ªç©ºæ¢ç´¢ã€‚

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

é€šè¿‡å¯¹æ¯”åŸæ¸¸æˆä»£ç å’ŒFlutteré¡¹ç›®å®ç°ï¼Œå‘ç°ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

### é—®é¢˜1ï¼šçŠ¶æ€è®¾ç½®ä¸ä¸€è‡´

**åŸæ¸¸æˆå®ç°**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```javascript
// adarkroom/script/events/setpieces.js:3147
World.state.ship = true;  // ç›´æ¥è®¾ç½®åˆ°World.state
```

**Flutteré¡¹ç›®å®ç°**ï¼ˆé”™è¯¯ï¼‰ï¼š
```dart
// lib/modules/setpieces.dart:2710
sm.set('game.world.ship', true);  // é”™è¯¯ï¼šè®¾ç½®åˆ°StateManager
```

**æ£€æŸ¥é€»è¾‘**ï¼š
```dart
// lib/modules/world.dart:1419
if (state!['ship'] == true &&  // æ£€æŸ¥World.state['ship']
    !sm.get('features.location.spaceShip', true)) {
```

**é—®é¢˜åˆ†æ**ï¼šè®¾ç½®å’Œæ£€æŸ¥ä½¿ç”¨ä¸åŒçš„æ•°æ®æºï¼Œå¯¼è‡´æ¡ä»¶æ°¸è¿œä¸æ»¡è¶³ã€‚

### é—®é¢˜2ï¼šShip.init()è¢«æ³¨é‡Š

**åŸæ¸¸æˆå®ç°**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```javascript
// adarkroom/script/world.js:966
Ship.init();  // ç›´æ¥è°ƒç”¨
```

**Flutteré¡¹ç›®å®ç°**ï¼ˆé”™è¯¯ï¼‰ï¼š
```dart
// lib/modules/world.dart:1421
// Ship.init(); // æš‚æ—¶æ³¨é‡Šæ‰ï¼Œéœ€è¦å®ç°Shipæ¨¡å—
```

**é—®é¢˜åˆ†æ**ï¼šå³ä½¿çŠ¶æ€æ£€æŸ¥æ­£ç¡®ï¼ŒShip.init()ä¹Ÿä¸ä¼šè¢«è°ƒç”¨ã€‚

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šç»Ÿä¸€çŠ¶æ€è®¾ç½®

ä¿®æ”¹`activateShip()`æ–¹æ³•ï¼Œç›´æ¥è®¾ç½®åˆ°World.stateï¼š

**æ–‡ä»¶**: `lib/modules/setpieces.dart`

```dart
/// æ¿€æ´»æ˜Ÿèˆ° - å‚è€ƒåŸæ¸¸æˆ World.state.ship = true
void activateShip() {
  final world = World();
  world.markVisited(world.curPos[0], world.curPos[1]);
  world.drawRoad();
  
  // è®¾ç½®ä¸–ç•ŒçŠ¶æ€ - å‚è€ƒåŸæ¸¸æˆ World.state.ship = true
  world.state = world.state ?? {};
  world.state!['ship'] = true;  // æ­£ç¡®ï¼šè®¾ç½®åˆ°world.state
  
  Logger.info('ğŸš€ å æ¯æ˜Ÿèˆ°äº‹ä»¶å®Œæˆï¼Œè®¾ç½® World.state.ship = true');
  Logger.info('ğŸš€ å½“å‰ä¸–ç•ŒçŠ¶æ€: ${world.state}');
  notifyListeners();
}
```

### ä¿®å¤2ï¼šå¯ç”¨Shipæ¨¡å—åˆå§‹åŒ–

**æ–‡ä»¶**: `lib/modules/world.dart`

1. æ·»åŠ Shipæ¨¡å—å¯¼å…¥ï¼š
```dart
import 'ship.dart';
```

2. å¯ç”¨Ship.init()è°ƒç”¨ï¼š
```dart
if (state!['ship'] == true &&
    !sm.get('features.location.spaceShip', true)) {
  Logger.info('ğŸš€ æ£€æµ‹åˆ°shipçŠ¶æ€ä¸ºtrueï¼Œå¼€å§‹åˆå§‹åŒ–Shipæ¨¡å—');
  Ship().init(); // å¯ç”¨Shipæ¨¡å—åˆå§‹åŒ– - å‚è€ƒåŸæ¸¸æˆ Ship.init()
  sm.set('features.location.spaceShip', true);
  Logger.info('ğŸ  è§£é”æ˜Ÿèˆ°é¡µç­¾å®Œæˆ');
}
```

## ğŸ›¡ï¸ é‡è¦ä¿æŠ¤æªæ–½

### ç¡®ä¿æ‘åº„è¿”å›é€»è¾‘ä¸å—å½±å“

**å…³é”®è¦æ±‚**ï¼šä¿®æ”¹æ—¶å¿…é¡»ä¿æŒåœ°å›¾ä¸­ç»è¿‡åœ°æ ‡Aè¿”å›æ‘åº„çš„é€»è¾‘ä¸å˜ã€‚

**ä¿æŠ¤çš„ä»£ç **ï¼š
```dart
// lib/modules/world.dart:876-877
if (curTile == tile['village']) {
  Logger.info('ğŸ  è§¦å‘æ‘åº„äº‹ä»¶ - å›åˆ°å°é»‘å±‹');
  goHome();  // è¿™ä¸ªé€»è¾‘ç»å¯¹ä¸èƒ½æ”¹å˜
}
```

**éªŒè¯æ–¹æ³•**ï¼š
1. ç¡®ä¿ç©å®¶ç§»åŠ¨åˆ°åœ°æ ‡Aæ—¶ä»èƒ½è‡ªåŠ¨è¿”å›æ‘åº„
2. ç¡®ä¿goHome()æ–¹æ³•çš„è°ƒç”¨é€»è¾‘ä¸å˜
3. ç¡®ä¿è¿”å›æµç¨‹ä¸­çš„çŠ¶æ€æ£€æŸ¥æ­£å¸¸å·¥ä½œ

## âœ… ä¿®å¤éªŒè¯

### å®Œæ•´è§£é”æµç¨‹

ä¿®å¤åçš„ç ´æ—§æ˜Ÿèˆ°è§£é”æµç¨‹ï¼š

1. **æ¢ç´¢ä¸–ç•Œåœ°å›¾** â†’ æ‰¾åˆ°å æ¯æ˜Ÿèˆ°åœ°æ ‡ï¼ˆWç¬¦å·ï¼Œè·ç¦»æ‘åº„28æ ¼ï¼‰
2. **è®¿é—®å æ¯æ˜Ÿèˆ°** â†’ è§¦å‘shipåœºæ™¯äº‹ä»¶
3. **activateShip()** â†’ è®¾ç½®`World.state['ship'] = true`
4. **è¿”å›æ‘åº„** â†’ ç»è¿‡åœ°æ ‡Aæˆ–æ‰‹åŠ¨è¿”å›ï¼Œè§¦å‘goHome()
5. **çŠ¶æ€æ£€æŸ¥** â†’ æ£€æµ‹åˆ°`state['ship'] == true`
6. **Ship().init()** â†’ åˆ›å»º"ç ´æ—§æ˜Ÿèˆ°"é¡µç­¾
7. **é¡µç­¾æ˜¾ç¤º** â†’ ç©å®¶å¯ä»¥è®¿é—®æ˜Ÿèˆ°åŠŸèƒ½

### æµ‹è¯•éªŒè¯ç‚¹

- [ ] åº”ç”¨æ­£å¸¸å¯åŠ¨ï¼Œæ— ç¼–è¯‘é”™è¯¯
- [ ] ä¸–ç•Œåœ°å›¾æ¢ç´¢åŠŸèƒ½æ­£å¸¸
- [ ] å æ¯æ˜Ÿèˆ°åœ°æ ‡æ­£ç¡®ç”Ÿæˆ
- [ ] è®¿é—®å æ¯æ˜Ÿèˆ°è§¦å‘æ­£ç¡®äº‹ä»¶
- [ ] çŠ¶æ€è®¾ç½®æ­£ç¡®è®°å½•
- [ ] è¿”å›æ‘åº„ï¼ˆåœ°æ ‡Aï¼‰åŠŸèƒ½æ­£å¸¸
- [ ] Shipæ¨¡å—æ­£ç¡®åˆå§‹åŒ–
- [ ] "ç ´æ—§æ˜Ÿèˆ°"é¡µç­¾æ­£ç¡®æ˜¾ç¤º
- [ ] æ˜Ÿèˆ°ç•Œé¢åŠŸèƒ½æ­£å¸¸

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `lib/modules/setpieces.dart` - ä¿®å¤çŠ¶æ€è®¾ç½®é€»è¾‘
- `lib/modules/world.dart` - å¯ç”¨Shipæ¨¡å—åˆå§‹åŒ–ï¼Œæ·»åŠ å¯¼å…¥

### ç›¸å…³æ–‡ä»¶
- `lib/modules/ship.dart` - Shipæ¨¡å—å®ç°
- `lib/screens/ship_screen.dart` - æ˜Ÿèˆ°ç•Œé¢
- `lib/widgets/header.dart` - é¡µç­¾æ˜¾ç¤ºé€»è¾‘

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤å®Œæˆåï¼š
- âœ… ç©å®¶è®¿é—®å æ¯æ˜Ÿèˆ°åœ°æ ‡åï¼Œè¿”å›æ‘åº„æ—¶æ­£ç¡®æ˜¾ç¤º"ç ´æ—§æ˜Ÿèˆ°"é¡µç­¾
- âœ… æ˜Ÿèˆ°åŠŸèƒ½å®Œå…¨å¯ç”¨ï¼ŒåŒ…æ‹¬èˆ¹ä½“å¼ºåŒ–ã€å¼•æ“å‡çº§
- âœ… æ‘åº„è¿”å›é€»è¾‘ï¼ˆåœ°æ ‡Aï¼‰å®Œå…¨ä¸å—å½±å“
- âœ… æ¸¸æˆæµç¨‹å®Œæ•´ï¼Œç©å®¶å¯ä»¥ä½“éªŒå®Œæ•´çš„å¤ªç©ºæ¢ç´¢é˜¶æ®µ

---

*æœ¬ä¿®å¤ç¡®ä¿äº†ç ´æ—§æ˜Ÿèˆ°åŠŸèƒ½çš„æ­£ç¡®å®ç°ï¼ŒåŒæ—¶ä¸¥æ ¼ä¿æŠ¤äº†ç°æœ‰çš„æ‘åº„è¿”å›æœºåˆ¶ã€‚*
