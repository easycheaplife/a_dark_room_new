# A Dark Room - 生火间机制详解

## 概述

生火间（Room）是A Dark Room游戏的核心模块，管理着火焰、温度、建造者状态和建造系统。

## 核心系统

### 1. 火焰系统（Fire System）

#### 火焰状态枚举
```
Dead (0) - 熄灭
Smoldering (1) - 闷烧
Flickering (2) - 摇曳
Burning (3) - 燃烧
Roaring (4) - 熊熊燃烧
```

#### 火焰机制
- **点燃火堆**：
  - 如果没有木材：免费点燃到Burning状态
  - 如果有木材但少于5个：显示"木材不足"
  - 如果有5个或更多木材：消耗5个木材，点燃到Burning状态

- **添柴**：
  - 消耗1个木材
  - 火焰等级+1（最高到Roaring）

- **火焰冷却**：
  - 每30秒自动降低1个火焰等级
  - 建造者等级>3且有木材时，会自动添柴维持火焰

### 2. 温度系统（Temperature System）

#### 温度状态枚举
```
Freezing (0) - 冰冷
Cold (1) - 寒冷
Mild (2) - 温和
Warm (3) - 温暖
Hot (4) - 炎热
```

#### 温度机制
- **温度调节**：每5秒检查一次
- **升温**：当温度 < 火焰等级时，温度+1
- **降温**：当温度 > 火焰等级时，温度-1
- **温度影响**：
  - 温度 ≤ Cold：建造者拒绝工作（"建造者只是在发抖"）
  - 温度 ≥ Warm：建造者状态可以升级

### 3. 建造者系统（Builder System）

#### 建造者等级
```
-1: 未出现
0: 刚出现（火焰>Flickering时触发）
1: 陌生人到达
2: 陌生人不再颤抖
3: 陌生人平静下来
4: 建造者（开始帮助建造和生产木材）
```

#### 建造者升级条件
- **等级0→1**：10秒后自动升级
- **等级1→2**：温度达到Warm时升级
- **等级2→3**：温度达到Warm时升级
- **等级3→4**：进入房间时自动升级，开始生产木材（每10秒2个）

### 4. 建造系统（Building System）

#### 建造条件
1. **建造者等级**：必须≥4
2. **温度要求**：必须>Cold（温度≥Mild）
3. **资源要求**：必须有足够的材料
4. **数量限制**：不能超过最大建造数量

#### 建造类型
- **建筑物**（buildings）：小屋、工坊、贸易站等
- **工具**（tools）：陷阱、推车、指南针等
- **武器**（weapons）：刀、步枪、子弹等
- **防具**（armour）：皮甲、铁甲、钢甲

## 关键时间参数

```dart
static const int _fireCoolDelay = 30000;      // 火焰冷却间隔：30秒
static const int _roomWarmDelay = 5000;       // 温度调节间隔：5秒
static const int _builderStateDelay = 10000;  // 建造者状态更新：10秒
static const int _needWoodDelay = 3000;       // 需要木材提示延迟：3秒
```

## 游戏流程

### 初始阶段
1. 玩家开始时房间冰冷，火焰熄灭
2. 点燃火堆（免费，因为没有木材）
3. 火焰达到Flickering以上时，建造者出现（等级0）

### 发展阶段
1. 建造者升级到等级1，解锁森林
2. 收集木材，维持火焰
3. 温度升高，建造者继续升级
4. 建造者达到等级4，开始帮助建造

### 建造阶段
1. 温度必须保持在Mild以上
2. 建造各种建筑和工具
3. 逐步解锁更高级的内容

## 常见问题

### "建造者只是在发抖"
**原因**：房间温度太低（≤Cold）
**解决方案**：
1. 点燃或添柴提高火焰等级
2. 等待温度自动调节到Mild以上
3. 确保有足够木材维持火焰

### 建造者不升级
**原因**：温度不够高
**解决方案**：
1. 保持火焰在Burning或Roaring状态
2. 等待温度达到Warm
3. 确保建造者状态更新计时器正常运行

## 技术实现要点

### 状态存储
- `game.fire.value`：火焰等级
- `game.temperature.value`：温度等级
- `game.builder.level`：建造者等级

### 计时器管理
- 火焰冷却计时器
- 温度调节计时器
- 建造者状态更新计时器

### 事件通知
- 火焰状态变化通知
- 温度变化通知
- 建造者状态变化通知
