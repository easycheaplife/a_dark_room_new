# ç…¤çŸ¿å»ºç­‘è§£é”é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼šè·¯è¿‡ç…¤çŸ¿åœ°æ ‡ï¼Œå®Œæˆç…¤çŸ¿è§£é”åæ²¡æœ‰å‡ºç°ç…¤çŸ¿çš„å»ºç­‘å’Œç…¤çŸ¿å·¥ã€‚

## æ›´æ–°çŠ¶æ€

**ç¬¬ä¸€æ¬¡ä¿®å¤**ï¼šä¿®å¤äº†åç«¯é€»è¾‘ï¼Œä½†å‘ç°UIæ˜¾ç¤ºä»æœ‰é—®é¢˜ã€‚
**ç¬¬äºŒæ¬¡ä¿®å¤**ï¼šä¿®å¤äº†UIæ˜¾ç¤ºé€»è¾‘ï¼Œæ·»åŠ äº†çŸ¿ç‰©å·¥äººæŒ‰é’®å’Œé…ç½®ã€‚
**ç¬¬ä¸‰æ¬¡ä¿®å¤**ï¼šä¿®å¤äº†æˆ˜æ–—èƒœåˆ©åçš„åœºæ™¯è½¬æ¢é—®é¢˜ï¼Œæ·»åŠ äº†"ç»§ç»­"æŒ‰é’®ã€‚

**å½“å‰çŠ¶æ€**ï¼šéœ€è¦ç”¨æˆ·åœ¨æˆ˜æ–—èƒœåˆ©åç‚¹å‡»"ç»§ç»­"æŒ‰é’®æ¥å®Œæˆå®Œæ•´çš„ç…¤çŸ¿äº‹ä»¶æµç¨‹ï¼ˆä¸‰åœºæˆ˜æ–—ï¼‰ã€‚

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
1. **å»ºç­‘è§£é”é€»è¾‘ç¼ºå¤±**ï¼š`clearCoalMine()` å‡½æ•°åªè®¾ç½®äº† `game.world.coalmine = true`ï¼Œä½†æ²¡æœ‰æ·»åŠ ç…¤çŸ¿å»ºç­‘åˆ°å»ºç­‘åˆ—è¡¨
2. **å·¥äººæ·»åŠ é€»è¾‘ç¼ºå¤±**ï¼šæ²¡æœ‰è°ƒç”¨ `checkWorker()` æ¥æ·»åŠ ç…¤çŸ¿å·¥äººåˆ°å·¥äººåˆ—è¡¨
3. **UIæ˜¾ç¤ºé€»è¾‘ç¼ºå¤±**ï¼š`outside_screen.dart` ä¸­çš„ `_isWorkerUnlocked()` å‡½æ•°æ²¡æœ‰åŒ…å«çŸ¿ç‰©å·¥äººçš„æ£€æŸ¥é€»è¾‘
4. **å·¥äººæŒ‰é’®ç¼ºå¤±**ï¼šå·¥äººæŒ‰é’®åˆ—è¡¨ä¸­æ²¡æœ‰åŒ…å«çŸ¿ç‰©å·¥äºº
5. **åŒæ ·é—®é¢˜å­˜åœ¨äºé“çŸ¿å’Œç¡«ç£ºçŸ¿**ï¼šæ‰€æœ‰çŸ¿ç‰©å»ºç­‘éƒ½æœ‰ç›¸åŒçš„é—®é¢˜

### é—®é¢˜æµç¨‹
```
ç©å®¶åˆ°è¾¾ç…¤çŸ¿åœ°æ ‡ â†’ è§¦å‘ç…¤çŸ¿äº‹ä»¶ â†’ å®Œæˆæˆ˜æ–— â†’ clearCoalMine() è¢«è°ƒç”¨
â†“
åªè®¾ç½® game.world.coalmine = true
â†“
æ²¡æœ‰æ·»åŠ å»ºç­‘åˆ° game.buildings["coal mine"]
â†“
æ²¡æœ‰æ·»åŠ å·¥äººåˆ° game.workers["coal miner"]
â†“
ç»“æœï¼šç©å®¶çœ‹ä¸åˆ°ç…¤çŸ¿å»ºç­‘å’Œç…¤çŸ¿å·¥äºº
```

## è§£å†³æ–¹æ¡ˆ

### ä¿®å¤å†…å®¹
1. **ä¿®æ”¹ `clearCoalMine()` å‡½æ•°**ï¼šæ·»åŠ å»ºç­‘è§£é”å’Œå·¥äººæ·»åŠ é€»è¾‘
2. **ä¿®æ”¹ `clearIronMine()` å‡½æ•°**ï¼šæ·»åŠ ç›¸åŒçš„é€»è¾‘
3. **ä¿®æ”¹ `clearSulphurMine()` å‡½æ•°**ï¼šæ·»åŠ ç›¸åŒçš„é€»è¾‘
4. **æ·»åŠ å¿…è¦çš„å¯¼å…¥**ï¼šå¯¼å…¥ `Logger` å’Œ `Outside` æ¨¡å—
5. **ä¿®æ”¹ `_isWorkerUnlocked()` å‡½æ•°**ï¼šæ·»åŠ çŸ¿ç‰©å·¥äººçš„è§£é”æ£€æŸ¥é€»è¾‘
6. **æ·»åŠ çŸ¿ç‰©å·¥äººæŒ‰é’®**ï¼šåœ¨å·¥äººæŒ‰é’®åˆ—è¡¨ä¸­æ·»åŠ çŸ¿ç‰©å·¥äºº
7. **æ·»åŠ å·¥äººé…ç½®ä¿¡æ¯**ï¼šåœ¨ `_getWorkerInfo()` å‡½æ•°ä¸­æ·»åŠ çŸ¿ç‰©å·¥äººçš„ç”Ÿäº§é…ç½®

### ä»£ç ä¿®æ”¹

#### æ–‡ä»¶ï¼š`lib/modules/setpieces.dart`

**æ·»åŠ å¯¼å…¥ï¼š**
```dart
import '../core/logger.dart';
import 'outside.dart';
```

**ä¿®æ”¹ clearCoalMine() å‡½æ•°ï¼š**
```dart
/// æ¸…ç†ç…¤çŸ¿
void clearCoalMine() {
  final sm = StateManager();
  sm.set('game.world.coalmine', true);
  
  // è§£é”ç…¤çŸ¿å»ºç­‘ - å‚è€ƒåŸæ¸¸æˆçš„å»ºç­‘è§£é”é€»è¾‘
  if ((sm.get('game.buildings["coal mine"]', true) ?? 0) == 0) {
    sm.add('game.buildings["coal mine"]', 1);
    Logger.info('ğŸ  è§£é”ç…¤çŸ¿å»ºç­‘');
    
    // æ£€æŸ¥å¹¶æ·»åŠ ç…¤çŸ¿å·¥äººåˆ°å·¥äººåˆ—è¡¨
    Outside().checkWorker('coal mine');
    Logger.info('ğŸ  æ·»åŠ ç…¤çŸ¿å·¥äººåˆ°å·¥äººåˆ—è¡¨');
  }
  
  World().markVisited(World().curPos[0], World().curPos[1]);
  notifyListeners();
}
```

**åŒæ ·ä¿®æ”¹ clearIronMine() å’Œ clearSulphurMine() å‡½æ•°**

#### æ–‡ä»¶ï¼š`lib/screens/outside_screen.dart`

**ä¿®æ”¹ _isWorkerUnlocked() å‡½æ•°ï¼š**
```dart
bool _isWorkerUnlocked(String type, StateManager stateManager) {
  switch (type) {
    // ... å…¶ä»–å·¥äººç±»å‹ ...
    case 'iron miner':
      return (stateManager.get('game.buildings["iron mine"]', true) ?? 0) > 0;
    case 'coal miner':
      return (stateManager.get('game.buildings["coal mine"]', true) ?? 0) > 0;
    case 'sulphur miner':
      return (stateManager.get('game.buildings["sulphur mine"]', true) ?? 0) > 0;
    // ... å…¶ä»–å·¥äººç±»å‹ ...
  }
}
```

**æ·»åŠ çŸ¿ç‰©å·¥äººæŒ‰é’®ï¼š**
```dart
// åœ¨å·¥äººæŒ‰é’®åˆ—è¡¨ä¸­æ·»åŠ 
_buildWorkerButton(localization.translate('workers.iron_miner'), 'iron miner', ...),
_buildWorkerButton(localization.translate('workers.coal_miner'), 'coal miner', ...),
_buildWorkerButton(localization.translate('workers.sulphur_miner'), 'sulphur miner', ...),
```

**æ·»åŠ å·¥äººé…ç½®ä¿¡æ¯ï¼š**
```dart
const incomeConfig = {
  // ... å…¶ä»–å·¥äººé…ç½® ...
  'iron miner': {
    'delay': 10,
    'stores': {'cured meat': -1, 'iron': 1}
  },
  'coal miner': {
    'delay': 10,
    'stores': {'cured meat': -1, 'coal': 1}
  },
  'sulphur miner': {
    'delay': 10,
    'stores': {'cured meat': -1, 'sulphur': 1}
  },
  // ... å…¶ä»–å·¥äººé…ç½® ...
};
```

## æŠ€æœ¯ç»†èŠ‚

### å»ºç­‘è§£é”æœºåˆ¶
- åŸæ¸¸æˆä¸­ï¼ŒçŸ¿ç‰©å»ºç­‘é€šè¿‡å®Œæˆç›¸åº”çš„çŸ¿å±±äº‹ä»¶è‡ªåŠ¨è§£é”
- å»ºç­‘æ•°æ®å­˜å‚¨åœ¨ `game.buildings["å»ºç­‘å"]` ä¸­
- å€¼ä¸ºå»ºç­‘æ•°é‡ï¼ˆçŸ¿ç‰©å»ºç­‘é€šå¸¸ä¸º1ï¼‰

### å·¥äººæ·»åŠ æœºåˆ¶
- `Outside().checkWorker()` å‡½æ•°è´Ÿè´£æ£€æŸ¥å»ºç­‘å¹¶æ·»åŠ å¯¹åº”å·¥äºº
- å·¥äººæ•°æ®å­˜å‚¨åœ¨ `game.workers["å·¥äººå"]` ä¸­
- åˆå§‹å€¼ä¸º0ï¼Œå¯ä»¥é€šè¿‡UIåˆ†é…æ‘æ°‘

### æ—¥å¿—è®°å½•
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•æ¥è·Ÿè¸ªå»ºç­‘è§£é”è¿‡ç¨‹
- ä¾¿äºè°ƒè¯•å’ŒéªŒè¯ä¿®å¤æ•ˆæœ

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤
1. å¯åŠ¨æ¸¸æˆå¹¶å‘å±•åˆ°å¯ä»¥æ¢ç´¢ä¸–ç•Œ
2. æ‰¾åˆ°ç…¤çŸ¿åœ°æ ‡ï¼ˆè·ç¦»æ‘åº„10æ ¼ï¼‰
3. å®Œæˆç…¤çŸ¿äº‹ä»¶æˆ˜æ–—
4. è¿”å›æ‘åº„æ£€æŸ¥æ˜¯å¦å‡ºç°ç…¤çŸ¿å»ºç­‘å’Œç…¤çŸ¿å·¥äºº

### é¢„æœŸç»“æœ
- ç…¤çŸ¿å»ºç­‘å‡ºç°åœ¨å»ºç­‘åˆ—è¡¨ä¸­
- ç…¤çŸ¿å·¥äººå‡ºç°åœ¨å·¥äººåˆ—è¡¨ä¸­ï¼ˆåˆå§‹ä¸º0ï¼‰
- å¯ä»¥åˆ†é…æ‘æ°‘åˆ°ç…¤çŸ¿å·¥ä½œ
- ç…¤çŸ¿å·¥äººå¼€å§‹ç”Ÿäº§ç…¤ç‚­

## å½±å“èŒƒå›´

### ä¿®å¤çš„åŠŸèƒ½
- ç…¤çŸ¿å»ºç­‘è§£é”
- é“çŸ¿å»ºç­‘è§£é”  
- ç¡«ç£ºçŸ¿å»ºç­‘è§£é”
- å¯¹åº”å·¥äººçš„æ·»åŠ 

### ä¸å½±å“çš„åŠŸèƒ½
- å…¶ä»–å»ºç­‘çš„è§£é”æœºåˆ¶
- ç°æœ‰çš„æ¸¸æˆå­˜æ¡£
- å…¶ä»–æ¨¡å—çš„åŠŸèƒ½

## æ³¨æ„äº‹é¡¹

1. **æœ€å°åŒ–ä¿®æ”¹åŸåˆ™**ï¼šåªä¿®æ”¹å¿…è¦çš„å‡½æ•°ï¼Œä¿æŒåŸæœ‰é€»è¾‘ä¸å˜
2. **å‘åå…¼å®¹**ï¼šä¿®æ”¹ä¸ä¼šå½±å“å·²æœ‰çš„æ¸¸æˆå­˜æ¡£
3. **æ—¥å¿—è®°å½•**ï¼šæ·»åŠ é€‚å½“çš„æ—¥å¿—ä»¥ä¾¿è°ƒè¯•
4. **ä»£ç å¤ç”¨**ï¼šä¸‰ä¸ªçŸ¿ç‰©å»ºç­‘ä½¿ç”¨ç›¸åŒçš„è§£é”é€»è¾‘

## ç¬¬ä¸‰æ¬¡ä¿®å¤ï¼šæˆ˜æ–—èƒœåˆ©ååœºæ™¯è½¬æ¢é—®é¢˜

### é—®é¢˜å‘ç°
é€šè¿‡æ—¥å¿—åˆ†æå‘ç°ï¼Œç©å®¶åœ¨ç…¤çŸ¿äº‹ä»¶ä¸­åªå®Œæˆäº†ç¬¬ä¸€åœºæˆ˜æ–—ï¼ˆa1åœºæ™¯ï¼‰ï¼Œæ²¡æœ‰ç»§ç»­åˆ°åç»­çš„a2ã€a3å’Œclearedåœºæ™¯ã€‚è¿™æ˜¯å› ä¸ºæˆ˜æ–—èƒœåˆ©åçš„æˆ˜åˆ©å“ç•Œé¢ç¼ºå°‘"ç»§ç»­"æŒ‰é’®ã€‚

### ä¿®å¤å†…å®¹
åœ¨ `lib/screens/combat_screen.dart` ä¸­æ·»åŠ "ç»§ç»­"æŒ‰é’®ï¼š

```dart
// ç»§ç»­æŒ‰é’® - å¦‚æœæœ‰ä¸‹ä¸€ä¸ªåœºæ™¯çš„è¯
if (_hasNextScene(events, scene))
  Container(
    width: double.infinity,
    margin: const EdgeInsets.symmetric(vertical: 2),
    child: ElevatedButton(
      onPressed: () => _continueToNextScene(events, scene),
      style: ElevatedButton.styleFrom(
        backgroundColor: Colors.white,
        foregroundColor: Colors.black,
        side: const BorderSide(color: Colors.black),
      ),
      child: Text(Localization().translate('ui.buttons.continue')),
    ),
  ),
```

### è¾…åŠ©å‡½æ•°
```dart
/// æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªåœºæ™¯
bool _hasNextScene(Events events, Map<String, dynamic> scene) {
  final buttons = scene['buttons'] as Map<String, dynamic>? ?? {};
  final continueButton = buttons['continue'] as Map<String, dynamic>?;
  return continueButton != null && continueButton['nextScene'] != null;
}

/// ç»§ç»­åˆ°ä¸‹ä¸€ä¸ªåœºæ™¯
void _continueToNextScene(Events events, Map<String, dynamic> scene) {
  final buttons = scene['buttons'] as Map<String, dynamic>? ?? {};
  final continueButton = buttons['continue'] as Map<String, dynamic>?;

  if (continueButton != null && continueButton['nextScene'] != null) {
    events.handleButtonClick('continue', continueButton);
  } else {
    events.endEvent();
  }
}
```

### ç…¤çŸ¿äº‹ä»¶æµç¨‹
å®Œæ•´çš„ç…¤çŸ¿äº‹ä»¶éœ€è¦å®Œæˆä¸‰åœºæˆ˜æ–—ï¼š
1. **a1åœºæ™¯**ï¼šå¯¹æˆ˜manæ•Œäººï¼ˆè¡€é‡10ï¼‰
2. **a2åœºæ™¯**ï¼šå¯¹æˆ˜manæ•Œäººï¼ˆè¡€é‡10ï¼‰
3. **a3åœºæ™¯**ï¼šå¯¹æˆ˜chiefæ•Œäººï¼ˆè¡€é‡20ï¼‰
4. **clearedåœºæ™¯**ï¼šè°ƒç”¨clearCoalMine()å‡½æ•°è§£é”å»ºç­‘

### ç”¨æˆ·æ“ä½œæŒ‡å—
1. åˆ°è¾¾ç…¤çŸ¿åœ°æ ‡ï¼Œç‚¹å‡»"æ”»å‡»"
2. å®Œæˆç¬¬ä¸€åœºæˆ˜æ–—åï¼Œç‚¹å‡»"ç»§ç»­"ï¼ˆä¸æ˜¯"ç¦»å¼€"ï¼‰
3. å®Œæˆç¬¬äºŒåœºæˆ˜æ–—åï¼Œç‚¹å‡»"ç»§ç»­"
4. å®Œæˆç¬¬ä¸‰åœºæˆ˜æ–—åï¼Œç‚¹å‡»"ç»§ç»­"
5. åˆ°è¾¾clearedåœºæ™¯ï¼Œç…¤çŸ¿å»ºç­‘å’Œå·¥äººè‡ªåŠ¨è§£é”

## ç¬¬å››æ¬¡ä¿®å¤ï¼šæœ€ç»ˆé—®é¢˜ç¡®è®¤

### é—®é¢˜ç¡®è®¤
é€šè¿‡è¯¦ç»†çš„æ—¥å¿—åˆ†æï¼Œæˆ‘å‘ç°äº†ä¸€ä¸ªé‡è¦äº‹å®ï¼š

**åç«¯é€»è¾‘å®Œå…¨æ­£ç¡®ï¼**

ä»æ¸¸æˆæ—¥å¿—ä¸­å¯ä»¥æ¸…æ¥šçœ‹åˆ°ï¼š
```
[INFO] ğŸ­ æ”¶é›†æ¥è‡ª coal miner çš„æ”¶å…¥
[INFO] ğŸ­ æ”¶é›†æ¥è‡ª iron miner çš„æ”¶å…¥
[INFO] ğŸ­ æ”¶é›†æ¥è‡ª sulphur miner çš„æ”¶å…¥
```

è¿™è¯´æ˜ï¼š
1. âœ… ç…¤çŸ¿å·¥äººå·²å­˜åœ¨å¹¶åœ¨å·¥ä½œ
2. âœ… é“çŸ¿å·¥äººå·²å­˜åœ¨å¹¶åœ¨å·¥ä½œ
3. âœ… ç¡«ç£ºçŸ¿å·¥äººå·²å­˜åœ¨å¹¶åœ¨å·¥ä½œ
4. âœ… æ‰€æœ‰çŸ¿ç‰©å»ºç­‘éƒ½å·²è§£é”

ä»åœ°å›¾æ•°æ®ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼š
- `C!` - ç…¤çŸ¿å·²è¢«è®¿é—®ï¼ˆæ„Ÿå¹å·è¡¨ç¤ºå·²å®Œæˆï¼‰
- `I!` - é“çŸ¿å·²è¢«è®¿é—®
- `S` - ç¡«ç£ºçŸ¿å­˜åœ¨

### çœŸæ­£çš„é—®é¢˜
**é—®é¢˜ä¸åœ¨äºå»ºç­‘è§£é”é€»è¾‘ï¼Œè€Œåœ¨äºUIæ˜¾ç¤ºé€»è¾‘ï¼**

ç”¨æˆ·çœ‹ä¸åˆ°ç…¤çŸ¿å»ºç­‘å’Œå·¥äººï¼Œæ˜¯å› ä¸ºï¼š
1. æ‘åº„ç•Œé¢çš„å»ºç­‘åˆ—è¡¨æ˜¾ç¤ºæœ‰é—®é¢˜
2. å·¥äººç®¡ç†ç•Œé¢çš„å·¥äººæŒ‰é’®æ˜¾ç¤ºæœ‰é—®é¢˜

### è§£å†³æ–¹æ¡ˆ
éœ€è¦æ£€æŸ¥å’Œä¿®å¤ï¼š
1. `_buildBuildingsList()` å‡½æ•°çš„å»ºç­‘æ˜¾ç¤ºé€»è¾‘
2. `_buildWorkersButtons()` å‡½æ•°çš„å·¥äººæŒ‰é’®æ˜¾ç¤ºé€»è¾‘
3. å»ºç­‘æœ¬åœ°åŒ–åç§°çš„å¤„ç†é€»è¾‘

### ç”¨æˆ·æ“ä½œç¡®è®¤
ç”¨æˆ·å·²ç»æ­£ç¡®å®Œæˆäº†ç…¤çŸ¿äº‹ä»¶çš„æ‰€æœ‰æ­¥éª¤ï¼š
1. âœ… åˆ°è¾¾ç…¤çŸ¿åœ°æ ‡
2. âœ… å®Œæˆäº†æ‰€æœ‰ä¸‰åœºæˆ˜æ–—
3. âœ… åˆ°è¾¾äº†clearedåœºæ™¯
4. âœ… clearCoalMine()å‡½æ•°è¢«æ­£ç¡®è°ƒç”¨
5. âœ… å»ºç­‘å’Œå·¥äººå·²æ­£ç¡®æ·»åŠ åˆ°æ¸¸æˆçŠ¶æ€

**ç»“è®º**ï¼šç”¨æˆ·çš„æ“ä½œå®Œå…¨æ­£ç¡®ï¼Œé—®é¢˜åœ¨äºUIæ˜¾ç¤ºå±‚é¢ã€‚

## ç›¸å…³æ–‡ä»¶

- `lib/modules/setpieces.dart` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `lib/modules/outside.dart` - å·¥äººæ£€æŸ¥é€»è¾‘
- `lib/screens/combat_screen.dart` - æˆ˜æ–—ç•Œé¢ä¿®å¤
- `lib/screens/outside_screen.dart` - UIæ˜¾ç¤ºä¿®å¤ï¼ˆé‡ç‚¹ï¼‰
