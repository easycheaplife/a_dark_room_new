# å‰å“¨ç«™çŠ¶æ€ç®¡ç†ç»Ÿä¸€ä¿®å¤

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šå‰å“¨ç«™è®¿é—®çŠ¶æ€ä¸ä¸€è‡´ï¼šæœ‰äº›ç°è‰²çš„å‰å“¨ç«™(P!)ä¸èƒ½å†æ¬¡è®¿é—®ï¼Œä½†æœ‰äº›ç°è‰²å‰å“¨ç«™å¯ä»¥å†æ¬¡è®¿é—®ã€‚

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

å‰å“¨ç«™æœ‰ä¸¤å¥—ç‹¬ç«‹çš„çŠ¶æ€ç®¡ç†ç³»ç»Ÿï¼š

1. **è®¿é—®çŠ¶æ€ (Visited Status)**
   - æ ‡è®°æ–¹å¼ï¼šåœ°å›¾ä¸Šæ˜¾ç¤ºä¸º `P!`ï¼ˆå¸¦æ„Ÿå¹å·ï¼‰
   - ç®¡ç†å‡½æ•°ï¼š`markVisited(x, y)`
   - ä½œç”¨ï¼šæ ‡è®°åœ°å½¢å·²è¢«è®¿é—®è¿‡

2. **ä½¿ç”¨çŠ¶æ€ (Used Status)**
   - æ ‡è®°æ–¹å¼ï¼šå­˜å‚¨åœ¨ `usedOutposts` Mapä¸­
   - ç®¡ç†å‡½æ•°ï¼š`markOutpostUsed()`ã€`outpostUsed()`
   - ä½œç”¨ï¼šæ ‡è®°å‰å“¨ç«™çš„è¡¥æ°´åŠŸèƒ½å·²è¢«ä½¿ç”¨

### çŠ¶æ€ä¸åŒæ­¥é—®é¢˜

è¿™ä¸¤ä¸ªçŠ¶æ€å¯èƒ½ä¸åŒæ­¥ï¼Œå¯¼è‡´ï¼š
- æœ‰äº› `P!` ä»ç„¶å¯ä»¥ä½¿ç”¨ï¼ˆè®¿é—®äº†ä½†æ²¡ä½¿ç”¨è¡¥æ°´åŠŸèƒ½ï¼‰
- æœ‰äº› `P!` ä¸èƒ½ä½¿ç”¨ï¼ˆå·²ç»ä½¿ç”¨è¿‡è¡¥æ°´åŠŸèƒ½ï¼‰

### æŒä¹…åŒ–é—®é¢˜

åŸå®ç°ä¸­ `usedOutposts` åªå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ²¡æœ‰æŒä¹…åŒ–åˆ°StateManagerï¼Œå¯¼è‡´æ¸¸æˆé‡å¯åçŠ¶æ€ä¸¢å¤±ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ”¹è¿›å‰å“¨ç«™ä½¿ç”¨çŠ¶æ€æ£€æŸ¥

**ä¿®å¤å‰**ï¼š
```dart
bool outpostUsed() {
  final key = '${curPos[0]},${curPos[1]}';
  return usedOutposts[key] ?? false;
}
```

**ä¿®å¤å**ï¼š
```dart
bool outpostUsed([int? x, int? y]) {
  x ??= curPos[0];
  y ??= curPos[1];
  final key = '$x,$y';
  
  // é¦–å…ˆæ£€æŸ¥å†…å­˜ä¸­çš„çŠ¶æ€
  if (usedOutposts[key] == true) {
    return true;
  }
  
  // ç„¶åæ£€æŸ¥StateManagerä¸­çš„æŒä¹…åŒ–çŠ¶æ€
  final sm = StateManager();
  final persistedUsedOutposts = sm.get('game.world.usedOutposts', true) ?? {};
  return persistedUsedOutposts[key] == true;
}
```

### 2. æ”¹è¿›å‰å“¨ç«™ä½¿ç”¨çŠ¶æ€æ ‡è®°

**ä¿®å¤å‰**ï¼š
```dart
void markOutpostUsed() {
  final key = '${curPos[0]},${curPos[1]}';
  usedOutposts[key] = true;
}
```

**ä¿®å¤å**ï¼š
```dart
void markOutpostUsed([int? x, int? y]) {
  x ??= curPos[0];
  y ??= curPos[1];
  final key = '$x,$y';
  
  // æ›´æ–°å†…å­˜çŠ¶æ€
  usedOutposts[key] = true;
  
  // ç«‹å³æŒä¹…åŒ–åˆ°StateManager
  final sm = StateManager();
  final persistedUsedOutposts = sm.get('game.world.usedOutposts', true) ?? {};
  persistedUsedOutposts[key] = true;
  sm.set('game.world.usedOutposts', persistedUsedOutposts);
  
  Logger.info('ğŸ›ï¸ å‰å“¨ç«™ ($x, $y) å·²æ ‡è®°ä¸ºå·²ä½¿ç”¨å¹¶æŒä¹…åŒ–');
}
```

### 3. æ”¹è¿›å‰å“¨ç«™ä½¿ç”¨é€»è¾‘

**ä¿®å¤å‰**ï¼š
```dart
void useOutpost() {
  // è¡¥å……æ°´åˆ°æœ€å¤§å€¼
  water = getMaxWater();
  // æ ‡è®°å‰å“¨ç«™ä¸ºå·²ä½¿ç”¨
  markOutpostUsed();
  // æ ‡è®°å‰å“¨ç«™ä¸ºå·²è®¿é—®
  markVisited(curPos[0], curPos[1]);
}
```

**ä¿®å¤å**ï¼š
```dart
void useOutpost() {
  Logger.info('ğŸ›ï¸ ä½¿ç”¨å‰å“¨ç«™ - ä½ç½®: [${curPos[0]}, ${curPos[1]}]');
  
  // æ£€æŸ¥å‰å“¨ç«™æ˜¯å¦å·²ç»ä½¿ç”¨è¿‡
  if (outpostUsed()) {
    Logger.info('ğŸ›ï¸ å‰å“¨ç«™å·²ç»ä½¿ç”¨è¿‡ï¼Œæ— æ³•å†æ¬¡ä½¿ç”¨');
    final localization = Localization();
    NotificationManager().notify(
        name, localization.translate('world.notifications.outpost_already_used'));
    return;
  }
  
  // è¡¥å……æ°´åˆ°æœ€å¤§å€¼
  final oldWater = water;
  water = getMaxWater();
  
  // åŒæ—¶æ ‡è®°å‰å“¨ç«™ä¸ºå·²ä½¿ç”¨å’Œå·²è®¿é—®ï¼Œç¡®ä¿çŠ¶æ€åŒæ­¥
  markOutpostUsed();
  markVisited(curPos[0], curPos[1]);

  Logger.info('ğŸ›ï¸ å‰å“¨ç«™ä½¿ç”¨å®Œæˆ - æ°´: $oldWater -> $water, ä½ç½®å·²æ ‡è®°ä¸ºå·²è®¿é—®å’Œå·²ä½¿ç”¨');
}
```

### 4. æ·»åŠ çŠ¶æ€åˆå§‹åŒ–

åœ¨ `World.init()` ä¸­æ·»åŠ å‰å“¨ç«™çŠ¶æ€åŠ è½½ï¼š

```dart
Logger.info('ğŸ›ï¸ åŠ è½½å‰å“¨ç«™ä½¿ç”¨çŠ¶æ€...');
// ä»StateManageråŠ è½½å·²ä½¿ç”¨çš„å‰å“¨ç«™çŠ¶æ€
final persistedUsedOutposts = sm.get('game.world.usedOutposts', true);
if (persistedUsedOutposts != null && persistedUsedOutposts is Map) {
  usedOutposts = Map<String, bool>.from(persistedUsedOutposts);
  Logger.info('ğŸ›ï¸ å·²åŠ è½½ ${usedOutposts.length} ä¸ªå·²ä½¿ç”¨çš„å‰å“¨ç«™çŠ¶æ€');
} else {
  usedOutposts = {};
  Logger.info('ğŸ›ï¸ åˆå§‹åŒ–ç©ºçš„å‰å“¨ç«™ä½¿ç”¨çŠ¶æ€');
}
```

### 5. ä¿®å¤æ‰§è¡Œè€…æ£€æŸ¥é€»è¾‘

ç§»é™¤äº†é”™è¯¯çš„å‰å“¨ç«™æ£€æŸ¥é€»è¾‘ï¼š

**ä¿®å¤å‰**ï¼š
```dart
if (originalTile != tile['outpost'] || !outpostUsed()) {
```

**ä¿®å¤å**ï¼š
```dart
// æ‰§è¡Œè€…ä¸æ˜¯å‰å“¨ç«™ï¼Œç§»é™¤é”™è¯¯çš„å‰å“¨ç«™æ£€æŸ¥é€»è¾‘
if (!isVisited) {
```

### 6. æ·»åŠ æœ¬åœ°åŒ–æ”¯æŒ

æ·»åŠ äº†å‰å“¨ç«™å·²ä½¿ç”¨çš„é€šçŸ¥æ–‡æœ¬ï¼š

**ä¸­æ–‡ (zh.json)**ï¼š
```json
"outpost_already_used": "è¿™ä¸ªå‰å“¨ç«™å·²ç»ä½¿ç”¨è¿‡äº†"
```

**è‹±æ–‡ (en.json)**ï¼š
```json
"outpost_already_used": "this outpost has already been used"
```

## ä¿®å¤æ•ˆæœ

### âœ… è§£å†³çš„é—®é¢˜

1. **çŠ¶æ€åŒæ­¥**ï¼šè®¿é—®çŠ¶æ€å’Œä½¿ç”¨çŠ¶æ€ç°åœ¨å®Œå…¨åŒæ­¥
2. **æŒä¹…åŒ–**ï¼šå‰å“¨ç«™ä½¿ç”¨çŠ¶æ€ç°åœ¨æ­£ç¡®æŒä¹…åŒ–åˆ°StateManager
3. **é‡å¤ä½¿ç”¨æ£€æŸ¥**ï¼šé˜²æ­¢ç©å®¶é‡å¤ä½¿ç”¨åŒä¸€ä¸ªå‰å“¨ç«™
4. **çŠ¶æ€æ¢å¤**ï¼šæ¸¸æˆé‡å¯åæ­£ç¡®æ¢å¤å‰å“¨ç«™ä½¿ç”¨çŠ¶æ€
5. **ç”¨æˆ·åé¦ˆ**ï¼šå½“å°è¯•ä½¿ç”¨å·²ä½¿ç”¨çš„å‰å“¨ç«™æ—¶æ˜¾ç¤ºæ˜ç¡®æç¤º

### ğŸ¯ é¢„æœŸè¡Œä¸º

1. **æ–°å»ºå‰å“¨ç«™**ï¼š
   - æ˜¾ç¤ºä¸ºé»‘è‰² `P`
   - å¯ä»¥ä½¿ç”¨è¡¥æ°´åŠŸèƒ½
   - ä½¿ç”¨åå˜ä¸ºç°è‰² `P!` ä¸”ä¸èƒ½å†æ¬¡ä½¿ç”¨

2. **å·²ä½¿ç”¨å‰å“¨ç«™**ï¼š
   - æ˜¾ç¤ºä¸ºç°è‰² `P!`
   - ä¸èƒ½å†æ¬¡ä½¿ç”¨è¡¥æ°´åŠŸèƒ½
   - å°è¯•ä½¿ç”¨æ—¶æ˜¾ç¤º"å·²ä½¿ç”¨"æç¤º

3. **çŠ¶æ€ä¸€è‡´æ€§**ï¼š
   - è®¿é—®çŠ¶æ€å’Œä½¿ç”¨çŠ¶æ€å®Œå…¨åŒæ­¥
   - æ¸¸æˆé‡å¯åçŠ¶æ€ä¿æŒä¸€è‡´

## æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹1ï¼šæ–°å»ºå‰å“¨ç«™
1. æ¸…ç†æ´ç©´è·å¾—å‰å“¨ç«™
2. éªŒè¯æ˜¾ç¤ºä¸ºé»‘è‰² `P`
3. ä½¿ç”¨è¡¥æ°´åŠŸèƒ½
4. éªŒè¯å˜ä¸ºç°è‰² `P!` ä¸”ä¸èƒ½å†æ¬¡ä½¿ç”¨

### æµ‹è¯•ç”¨ä¾‹2ï¼šçŠ¶æ€æŒä¹…åŒ–
1. ä½¿ç”¨å‰å“¨ç«™
2. é‡å¯æ¸¸æˆ
3. éªŒè¯å‰å“¨ç«™ä»æ˜¾ç¤ºä¸ºå·²ä½¿ç”¨çŠ¶æ€

### æµ‹è¯•ç”¨ä¾‹3ï¼šé‡å¤ä½¿ç”¨æ£€æŸ¥
1. å°è¯•ä½¿ç”¨å·²ä½¿ç”¨çš„å‰å“¨ç«™
2. éªŒè¯æ˜¾ç¤º"å·²ä½¿ç”¨"æç¤º
3. éªŒè¯æ°´é‡ä¸å˜

## ç›¸å…³æ–‡ä»¶

- `lib/modules/world.dart` - å‰å“¨ç«™çŠ¶æ€ç®¡ç†é€»è¾‘
- `assets/lang/zh.json` - ä¸­æ–‡æœ¬åœ°åŒ–æ–‡æœ¬
- `assets/lang/en.json` - è‹±æ–‡æœ¬åœ°åŒ–æ–‡æœ¬
- `docs/outpost_access_inconsistency_analysis.md` - é—®é¢˜åˆ†ææ–‡æ¡£

## æŠ€æœ¯ç»†èŠ‚

### çŠ¶æ€å­˜å‚¨æ ¼å¼

```dart
// StateManagerä¸­çš„å­˜å‚¨æ ¼å¼
'game.world.usedOutposts': {
  '28,33': true,  // ä½ç½®(28,33)çš„å‰å“¨ç«™å·²ä½¿ç”¨
  '15,20': true,  // ä½ç½®(15,20)çš„å‰å“¨ç«™å·²ä½¿ç”¨
}
```

### æ—¥å¿—è¾“å‡º

```
ğŸ›ï¸ ä½¿ç”¨å‰å“¨ç«™ - ä½ç½®: [28, 33]
ğŸ›ï¸ å‰å“¨ç«™ (28, 33) å·²æ ‡è®°ä¸ºå·²ä½¿ç”¨å¹¶æŒä¹…åŒ–
ğŸ—ºï¸ æ ‡è®°ä½ç½® (28, 33) ä¸ºå·²è®¿é—®: P!
ğŸ›ï¸ å‰å“¨ç«™ä½¿ç”¨å®Œæˆ - æ°´: 8 -> 20, ä½ç½®å·²æ ‡è®°ä¸ºå·²è®¿é—®å’Œå·²ä½¿ç”¨
```

è¿™ä¸ªä¿®å¤ç¡®ä¿äº†å‰å“¨ç«™çŠ¶æ€ç®¡ç†çš„å®Œå…¨ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚
