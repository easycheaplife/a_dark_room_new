# 硫磺矿重复访问问题修复

**修复日期**: 2025-06-25  
**问题类型**: 游戏逻辑错误  
**影响范围**: 硫磺矿(S)地标的访问逻辑  

## 问题描述

### 用户报告
用户报告：硫磺矿S，进入后还是黑色的S，可以持续访问。

### 问题分析
通过代码分析发现，硫磺矿(S)地标的访问逻辑存在错误：

1. **错误行为**：硫磺矿在访问时立即被标记为已访问(`S!`)
2. **正确行为**：硫磺矿应该只有在完成setpiece事件后才标记为已访问
3. **与其他矿物地标的一致性**：铁矿(I)和煤矿(C)都有相同的问题，但已在之前修复

## 根本原因

### 代码问题位置
**文件**: `lib/modules/world.dart`  
**位置**: 第1029-1034行

**修复前的错误代码**:
```dart
case 'S': // 硫磺矿
  // 触发硫磺矿事件
  Events().triggerSetpiece('sulphurmine');
  // 立即标记为已访问，防止重复访问
  markVisited(curPos[0], curPos[1]);  // ❌ 错误：立即标记
  break;
```

### 问题原因
硫磺矿在触发setpiece事件后立即调用了`markVisited()`，这导致：
1. 玩家进入硫磺矿后，地形立即从`S`变为`S!`
2. 即使玩家没有完成setpiece事件，地形也被标记为已访问
3. 这与原游戏的行为不一致

## 修复方案

### 修复逻辑
硫磺矿应该遵循与其他矿物地标相同的逻辑：
1. **进入时**：不立即标记为已访问，允许重复访问
2. **完成事件时**：在`clearSulphurMine()`函数中标记为已访问

### 修复代码
**修复后的正确代码**:
```dart
case 'S': // 硫磺矿
  // 触发硫磺矿事件
  Events().triggerSetpiece('sulphurmine');
  // 注意：硫磺矿不立即标记为已访问，只有完成setpiece事件后才标记
  // 这与原游戏行为一致，允许玩家重复访问直到完成事件
  break;
```

### 验证setpiece事件逻辑
确认硫磺矿setpiece事件的完成逻辑正确：

**文件**: `lib/modules/setpieces.dart`
```dart
// 硫磺矿setpiece事件在完成时调用
'onLoad': 'clearSulphurMine',  // 第1463行

// clearSulphurMine函数正确标记为已访问
void clearSulphurMine() {
  final sm = StateManager();
  sm.set('game.world.sulphurmine', true);
  
  // 解锁硫磺矿建筑
  if ((sm.get('game.buildings["sulphur mine"]', true) ?? 0) == 0) {
    sm.add('game.buildings["sulphur mine"]', 1);
    Outside().checkWorker('sulphur mine');
  }
  
  World().markVisited(World().curPos[0], World().curPos[1]); // ✅ 正确时机
  notifyListeners();
}
```

## 修复效果

### 修复前
- ❌ 硫磺矿访问后立即变为`S!`
- ❌ 玩家无法重复访问硫磺矿
- ❌ 与原游戏行为不一致

### 修复后
- ✅ 硫磺矿访问后保持`S`状态
- ✅ 玩家可以重复访问硫磺矿直到完成事件
- ✅ 只有完成setpiece事件后才变为`S!`
- ✅ 与原游戏行为一致

## 与其他地标的一致性

### 矿物地标统一逻辑
现在所有矿物地标都遵循相同的访问逻辑：

| 地标 | 进入时 | 完成事件后 | 状态管理 |
|------|--------|------------|----------|
| 铁矿(I) | 不标记 | 标记为`I!` | ✅ 一致 |
| 煤矿(C) | 不标记 | 标记为`C!` | ✅ 一致 |
| 硫磺矿(S) | 不标记 | 标记为`S!` | ✅ 一致 |

### 特殊访问机制地标
以下地标有特殊的访问机制，不立即标记：
- 洞穴(V)：允许重复探索，完成后转换为前哨站
- 硫磺矿(S)：允许重复访问，完成后标记为已访问
- 执行者(X)：等待完整事件实现

## 技术细节

### 访问状态检查
硫磺矿的访问状态检查逻辑：
```dart
// 在move()方法中，硫磺矿被排除在立即标记列表之外
if (sceneName != 'cave' && 
    sceneName != 'house' && 
    sceneName != 'ironmine' && 
    sceneName != 'coalmine' && 
    sceneName != 'sulphurmine' &&  // ✅ 正确排除
    sceneName != 'town' && 
    sceneName != 'city') {
  markVisited(curPos[0], curPos[1]);
}
```

### 状态持久化
硫磺矿的状态变化：
1. **临时状态**：探险期间的访问状态保存在临时`state`对象中
2. **永久保存**：回到村庄时通过`goHome()`保存到`StateManager`
3. **建筑解锁**：完成后解锁硫磺矿建筑和工人

## 测试验证

### 预期测试结果
1. **第一次访问硫磺矿**：
   - 地形保持`S`状态
   - 可以触发setpiece事件
   - 可以重复访问

2. **完成setpiece事件后**：
   - 地形变为`S!`状态
   - 不能再次触发事件
   - 解锁硫磺矿建筑

3. **与原游戏一致性**：
   - 行为与原游戏完全一致
   - 与其他矿物地标逻辑统一

## 总结

本次修复成功解决了硫磺矿重复访问的问题，通过移除立即标记逻辑，确保硫磺矿只有在完成setpiece事件后才被标记为已访问。这个修复：

1. **恢复了原游戏行为**：硫磺矿可以重复访问直到完成
2. **保持了逻辑一致性**：与其他矿物地标行为统一
3. **遵循了最小化修改原则**：只修改了有问题的部分代码
4. **维护了游戏平衡**：防止玩家通过重复访问获得过多奖励

**修复验证**：需要通过实际游戏测试确认硫磺矿的访问行为与原游戏一致。
