# åœ°å½¢ç³»ç»Ÿå®Œæ•´æŒ‡å—

**æœ€åæ›´æ–°**: 2025-06-26

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ˜¯A Dark Roomåœ°å½¢ç³»ç»Ÿçš„å®Œæ•´æŒ‡å—ï¼Œæ•´åˆäº†åœ°å½¢åˆ†æã€ä»£ç ä¸€è‡´æ€§æ£€æŸ¥ã€æ”¹è¿›è®¡åˆ’ã€åŸæ¸¸æˆå¯¹æ¯”ç­‰æ‰€æœ‰ç›¸å…³å†…å®¹ï¼Œä¸ºå¼€å‘è€…æä¾›ç»Ÿä¸€çš„å‚è€ƒèµ„æ–™ã€‚

## ğŸ—ºï¸ åœ°å½¢ç³»ç»ŸåŸºç¡€

### åœ°å½¢ç¬¦å·å®šä¹‰

A Dark Roomä½¿ç”¨å•å­—ç¬¦ç¬¦å·è¡¨ç¤ºä¸åŒçš„åœ°å½¢ç±»å‹ï¼š

| åœ°å½¢ç±»å‹ | ç¬¦å· | ä¸­æ–‡åç§° | è‹±æ–‡åç§° | æè¿° |
|----------|------|----------|----------|------|
| æ‘åº„ | `A` | æ‘åº„ | Village | ç©å®¶çš„èµ·å§‹ç‚¹å’Œå®‰å…¨åŒºåŸŸ |
| æ£®æ— | `;` | æ£®æ— | Forest | å¯è·å¾—æœ¨æçš„åŒºåŸŸ |
| ç”°é‡ | `,` | ç”°é‡ | Field | å¯è·å¾—é£Ÿç‰©çš„åŒºåŸŸ |
| è’åœ° | `.` | è’åœ° | Barrens | æœ€å¸¸è§çš„ç©ºæ—·åœ°å½¢ |
| é“è·¯ | `#` | é“è·¯ | Road | è¿æ¥æ‘åº„å’Œå‰å“¨ç«™çš„è·¯å¾„ |
| å‰å“¨ç«™ | `P` | å‰å“¨ç«™ | Outpost | å¯è¡¥å……æ°´æºçš„æ®ç‚¹ |

### åœ°æ ‡ç¬¦å·å®šä¹‰

| åœ°æ ‡ç±»å‹ | ç¬¦å· | ä¸­æ–‡åç§° | è‹±æ–‡åç§° | ç‰¹æ®Šå±æ€§ |
|----------|------|----------|----------|----------|
| é“çŸ¿ | `I` | é“çŸ¿ | Iron Mine | éœ€è¦ç«æŠŠï¼Œä¸€æ¬¡æ€§è®¿é—® |
| ç…¤çŸ¿ | `C` | ç…¤çŸ¿ | Coal Mine | å¯é‡å¤è®¿é—® |
| ç¡«ç£ºçŸ¿ | `S` | ç¡«ç£ºçŸ¿ | Sulfur Mine | å¯é‡å¤è®¿é—® |
| æ—§æˆ¿å­ | `H` | æ—§æˆ¿å­ | House | éšæœºäº‹ä»¶ |
| æ½®æ¹¿æ´ç©´ | `V` | æ½®æ¹¿æ´ç©´ | Cave | éœ€è¦ç«æŠŠï¼Œè½¬æ¢ä¸ºå‰å“¨ç«™ |
| åºŸå¼ƒå°é•‡ | `O` | åºŸå¼ƒå°é•‡ | Town | å¤æ‚äº‹ä»¶ï¼Œè½¬æ¢ä¸ºå‰å“¨ç«™ |
| åºŸå¢ŸåŸå¸‚ | `Y` | åºŸå¢ŸåŸå¸‚ | City | å¤æ‚äº‹ä»¶ï¼Œè½¬æ¢ä¸ºå‰å“¨ç«™ |
| å æ¯æ˜Ÿèˆ° | `W` | å æ¯æ˜Ÿèˆ° | Starship | ç‰¹æ®Šäº‹ä»¶ |
| é’»å­” | `B` | é’»å­” | Borehole | éšæœºäº‹ä»¶ |
| æˆ˜åœº | `F` | æˆ˜åœº | Battlefield | æˆ˜æ–—äº‹ä»¶ |
| é˜´æš—æ²¼æ³½ | `M` | é˜´æš—æ²¼æ³½ | Swamp | ç‰¹æ®Šç¯å¢ƒ |
| è¢«æ‘§æ¯çš„æ‘åº„ | `U` | è¢«æ‘§æ¯çš„æ‘åº„ | Destroyed Village | ç‰¹æ®Šäº‹ä»¶ |
| æ‰§è¡Œè€… | `X` | æ‰§è¡Œè€… | Executioner | Bossæˆ˜ï¼Œè½¬æ¢ä¸ºå‰å“¨ç«™ |

## ğŸ² åœ°å½¢ç”Ÿæˆæœºåˆ¶

### åŸºç¡€åœ°å½¢æ¦‚ç‡

```dart
// lib/modules/world.dart:178-181
tileProbs[tile['forest']!] = 0.15;   // æ£®æ— 15%
tileProbs[tile['field']!] = 0.35;    // ç”°é‡ 35%
tileProbs[tile['barrens']!] = 0.5;   // è’åœ° 50%
```

### åœ°æ ‡é…ç½®è¡¨

| åœ°æ ‡ | æ•°é‡ | æœ€å°è·ç¦» | æœ€å¤§è·ç¦» | ç‰¹æ®Šè¦æ±‚ |
|------|------|----------|----------|----------|
| é“çŸ¿(I) | 1 | 5 | 5 | å›ºå®šè·ç¦» |
| ç…¤çŸ¿(C) | 1 | 10 | 10 | å›ºå®šè·ç¦» |
| ç¡«ç£ºçŸ¿(S) | 1 | 20 | 20 | å›ºå®šè·ç¦» |
| æ—§æˆ¿å­(H) | 10 | 0 | 45 | éšæœºåˆ†å¸ƒ |
| æ½®æ¹¿æ´ç©´(V) | 5 | 3 | 10 | æ—©æœŸåŒºåŸŸ |
| åºŸå¼ƒå°é•‡(O) | 10 | 10 | 20 | ä¸­æœŸåŒºåŸŸ |
| åºŸå¢ŸåŸå¸‚(Y) | 20 | 20 | 45 | åæœŸåŒºåŸŸ |
| å æ¯æ˜Ÿèˆ°(W) | 1 | 28 | 28 | å›ºå®šè·ç¦» |
| é’»å­”(B) | 10 | 15 | 45 | ä¸­åæœŸåŒºåŸŸ |
| æˆ˜åœº(F) | 5 | 18 | 45 | åæœŸåŒºåŸŸ |
| é˜´æš—æ²¼æ³½(M) | 1 | 15 | 45 | ç‰¹æ®Šåœ°å½¢ |
| æ‰§è¡Œè€…(X) | 1 | 28 | 28 | å›ºå®šè·ç¦» |

## ğŸ”§ åœ°å½¢å¤„ç†é€»è¾‘

### doSpaceå‡½æ•°æ ¸å¿ƒé€»è¾‘

```dart
// lib/modules/world.dart:870-890
void doSpace(int x, int y) {
  final space = getSpace(x, y);
  
  if (space == tile['village']) {
    // æ‘åº„ï¼šç›´æ¥å›å®¶
    world.goHome();
  } else if (space == tile['outpost']) {
    // å‰å“¨ç«™ï¼šæ£€æŸ¥æ˜¯å¦å·²ä½¿ç”¨
    world.useOutpost();
  } else if (isLandmark(space)) {
    // åœ°æ ‡ï¼šæ£€æŸ¥è®¿é—®çŠ¶æ€
    if (!isVisited(x, y)) {
      startSetpiece(space);
    } else {
      handleVisitedLandmark(space);
    }
  } else {
    // æ™®é€šåœ°å½¢ï¼šæ¶ˆè€—è¡¥ç»™ï¼Œæ£€æŸ¥æˆ˜æ–—
    useSupplies();
    checkFight();
  }
}
```

### è®¿é—®çŠ¶æ€ç®¡ç†

```dart
// lib/modules/world.dart:1850-1860
void markVisited(int x, int y) {
  final sm = StateManager();
  final map = sm.get('game.world.map');
  if (map != null && map is List && map.isNotEmpty) {
    if (!map[x][y].endsWith('!')) {
      map[x][y] = map[x][y] + '!';
      sm.setM('game.world.map', map);
    }
  }
}
```

## ğŸ”¥ ç«æŠŠéœ€æ±‚ç³»ç»Ÿ

### éœ€è¦ç«æŠŠçš„åœ°å½¢

| åœ°å½¢ | ç¬¦å· | ç«æŠŠéœ€æ±‚ | æ£€æŸ¥æ–¹å¼ | æ¶ˆè€—æ—¶æœº |
|------|------|----------|----------|----------|
| æ½®æ¹¿æ´ç©´ | V | 1ä¸ª | èƒŒåŒ…æ£€æŸ¥ | è¿›å…¥æ—¶ |
| é“çŸ¿ | I | 1ä¸ª | èƒŒåŒ…æ£€æŸ¥ | è¿›å…¥æ—¶ |
| ç…¤çŸ¿ | C | æ—  | - | - |
| ç¡«ç£ºçŸ¿ | S | æ—  | - | - |
| åºŸå¼ƒå°é•‡ | O | éƒ¨åˆ†éœ€è¦ | èƒŒåŒ…æ£€æŸ¥ | ç‰¹å®šåœºæ™¯ |
| åºŸå¢ŸåŸå¸‚ | Y | éƒ¨åˆ†éœ€è¦ | èƒŒåŒ…æ£€æŸ¥ | ç‰¹å®šåœºæ™¯ |

### ç«æŠŠæ£€æŸ¥é€»è¾‘

```dart
// lib/modules/events.dart:1290-1314
bool canAffordBackpackCost(Map<String, dynamic> costs) {
  final path = Path();
  
  for (final entry in costs.entries) {
    final key = entry.key;
    final cost = entry.value as int;
    
    // å¯¹äºç«æŠŠç­‰å·¥å…·ï¼Œåªæ£€æŸ¥èƒŒåŒ…
    if (_isToolItem(key)) {
      final outfitAmount = path.outfit[key] ?? 0;
      if (outfitAmount < cost) {
        Logger.info('ğŸ’ èƒŒåŒ…ä¸­$keyä¸è¶³: éœ€è¦$cost, æ‹¥æœ‰$outfitAmount');
        return false;
      }
    }
  }
  return true;
}
```

## ğŸ›ï¸ åœ°æ ‡è½¬æ¢æœºåˆ¶

### è½¬æ¢åœ°æ ‡åˆ—è¡¨

ä»¥ä¸‹åœ°æ ‡åœ¨å®Œå…¨æ¢ç´¢åä¼šè½¬æ¢ä¸ºå‰å“¨ç«™ï¼š

| åœ°æ ‡ | ç¬¦å· | è½¬æ¢æ¡ä»¶ | è½¬æ¢å‡½æ•° |
|------|------|----------|----------|
| æ½®æ¹¿æ´ç©´ | V | å®Œå…¨æ¢ç´¢æ´ç©´äº‹ä»¶ | clearDungeon() |
| åºŸå¼ƒå°é•‡ | O | å®Œå…¨æ¢ç´¢å°é•‡äº‹ä»¶ | clearDungeon() |
| åºŸå¢ŸåŸå¸‚ | Y | å®Œå…¨æ¢ç´¢åŸå¸‚äº‹ä»¶ | clearCity() |
| æ‰§è¡Œè€… | X | å‡»è´¥æ‰§è¡Œè€… | activateExecutioner() |

### è½¬æ¢å®ç°é€»è¾‘

```dart
// lib/modules/world.dart:1877-1945
void clearDungeon() {
  Logger.info('ğŸ›ï¸ ========== World.clearDungeon() å¼€å§‹æ‰§è¡Œ ==========');
  
  if (state == null || state!['map'] == null) {
    Logger.error('âŒ çŠ¶æ€æˆ–åœ°å›¾æ•°æ®ä¸ºç©ºï¼');
    return;
  }

  try {
    final mapData = state!['map'];
    final map = List<List<String>>.from(mapData.map((row) => List<String>.from(row)));
    
    if (curPos[0] >= 0 && curPos[0] < map.length &&
        curPos[1] >= 0 && curPos[1] < map[curPos[0]].length) {
      
      // è½¬æ¢ä¸ºå‰å“¨ç«™
      map[curPos[0]][curPos[1]] = tile['outpost']!;
      
      // æ›´æ–°stateä¸­çš„åœ°å›¾æ•°æ®
      state!['map'] = map;
      
      // ç»˜åˆ¶é“è·¯è¿æ¥åˆ°å‰å“¨ç«™
      drawRoad();
      
      notifyListeners();
    }
  } catch (e, stackTrace) {
    Logger.error('âŒ clearDungeonå¤±è´¥: $e');
  }
  
  final sm = StateManager();
  sm.set('game.world.dungeonCleared', true);
  notifyListeners();
}
```

## ğŸ“Š ä»£ç ä¸€è‡´æ€§éªŒè¯

### éªŒè¯ç»“æœæ€»ç»“

| éªŒè¯é¡¹ç›® | ä¸€è‡´æ€§è¯„åˆ† | çŠ¶æ€ |
|----------|------------|------|
| åœ°å½¢ç¬¦å·å®šä¹‰ | 100% | âœ… å®Œå…¨ä¸€è‡´ |
| åœ°å½¢æ¦‚ç‡è®¾ç½® | 100% | âœ… å®Œå…¨ä¸€è‡´ |
| åœ°æ ‡é…ç½® | 100% | âœ… å®Œå…¨ä¸€è‡´ |
| åŸºç¡€å¤„ç†é€»è¾‘ | 95% | âœ… åŸºæœ¬ä¸€è‡´ |
| è®¿é—®çŠ¶æ€ç®¡ç† | 100% | âœ… å®Œå…¨ä¸€è‡´ |
| ç«æŠŠéœ€æ±‚é€»è¾‘ | 100% | âœ… å®Œå…¨ä¸€è‡´ |
| åœ°æ ‡è½¬æ¢æœºåˆ¶ | 95% | âœ… åŸºæœ¬ä¸€è‡´ |

### å‘ç°çš„é—®é¢˜

1. **åœ°å½¢Uçš„ç¿»è¯‘åç§°**: æ–‡æ¡£ä¸ä»£ç ä¸­çš„åç§°éœ€è¦ç»Ÿä¸€
2. **ç‰¹æ®Šæœºåˆ¶æè¿°**: æŸäº›ç‰¹æ®Šæœºåˆ¶éœ€è¦æ›´è¯¦ç»†çš„è¯´æ˜

## ğŸ® åŸæ¸¸æˆå¯¹æ¯”åˆ†æ

### æ ¸å¿ƒå·®å¼‚

1. **å®ç°è¯­è¨€**: JavaScript â†’ Dart
2. **çŠ¶æ€ç®¡ç†**: å…¨å±€å˜é‡ â†’ StateManager
3. **é”™è¯¯å¤„ç†**: åŸºç¡€æ£€æŸ¥ â†’ å®Œå–„çš„å¼‚å¸¸å¤„ç†
4. **æ—¥å¿—ç³»ç»Ÿ**: æ—  â†’ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

### ä¿æŒä¸€è‡´çš„è®¾è®¡

1. **åœ°å½¢ç¬¦å·**: å®Œå…¨ä¿æŒåŸæ¸¸æˆçš„ç¬¦å·ç³»ç»Ÿ
2. **æ¦‚ç‡åˆ†å¸ƒ**: ä¿æŒåŸæ¸¸æˆçš„åœ°å½¢ç”Ÿæˆæ¦‚ç‡
3. **æ¸¸æˆæœºåˆ¶**: ä¿æŒåŸæ¸¸æˆçš„æ ¸å¿ƒç©æ³•é€»è¾‘
4. **å¹³è¡¡æ€§**: ä¿æŒåŸæ¸¸æˆçš„éš¾åº¦æ›²çº¿

## ğŸ”® æ”¹è¿›è®¡åˆ’

### çŸ­æœŸæ”¹è¿› (1-2å‘¨)

1. **ç»Ÿä¸€å‘½å**: è§£å†³åœ°å½¢Uçš„åç§°ä¸ä¸€è‡´é—®é¢˜
2. **è¡¥å……æ–‡æ¡£**: å®Œå–„ç‰¹æ®Šæœºåˆ¶çš„è¯¦ç»†è¯´æ˜
3. **æ·»åŠ æµ‹è¯•**: ä¸ºæ¯ç§åœ°å½¢ç±»å‹æ·»åŠ å•å…ƒæµ‹è¯•

### ä¸­æœŸæ”¹è¿› (1-2æœˆ)

1. **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–åœ°å½¢ç”Ÿæˆå’Œå¤„ç†çš„æ€§èƒ½
2. **å¯è§†åŒ–å·¥å…·**: å¼€å‘åœ°å½¢åˆ†å¸ƒçš„å¯è§†åŒ–å·¥å…·
3. **è°ƒè¯•åŠŸèƒ½**: æ·»åŠ åœ°å½¢ç³»ç»Ÿçš„è°ƒè¯•ç•Œé¢

### é•¿æœŸæ”¹è¿› (3-6æœˆ)

1. **æ‰©å±•æ€§è®¾è®¡**: æ”¯æŒè‡ªå®šä¹‰åœ°å½¢ç±»å‹
2. **æ¨¡ç»„æ”¯æŒ**: å…è®¸ç©å®¶è‡ªå®šä¹‰åœ°å½¢é…ç½®
3. **AIä¼˜åŒ–**: ä½¿ç”¨AIä¼˜åŒ–åœ°å½¢ç”Ÿæˆç®—æ³•

## ğŸ“ æ›´æ–°å†å²

### 2025-06-26
- æ•´åˆäº†6ä¸ªåœ°å½¢ç›¸å…³æ–‡æ¡£
- ç»Ÿä¸€äº†åœ°å½¢ç³»ç»Ÿçš„å®Œæ•´æè¿°
- æ·»åŠ äº†ä»£ç ä¸€è‡´æ€§éªŒè¯ç»“æœ
- è¡¥å……äº†åŸæ¸¸æˆå¯¹æ¯”åˆ†æ
- åˆ¶å®šäº†è¯¦ç»†çš„æ”¹è¿›è®¡åˆ’

### å†å²å˜æ›´è®°å½•
- ç«æŠŠæ–‡æ¡£æ›´æ–°ï¼šç»Ÿä¸€äº†ç«æŠŠéœ€æ±‚æ£€æŸ¥é€»è¾‘
- æ´ç©´åœ°å½¢éªŒè¯ï¼šç¡®è®¤äº†æ´ç©´è½¬æ¢æœºåˆ¶çš„æ­£ç¡®æ€§
- ä»£ç ä¸€è‡´æ€§æ£€æŸ¥ï¼šéªŒè¯äº†96%çš„é«˜åº¦ä¸€è‡´æ€§

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ç«æŠŠç³»ç»Ÿå®Œæ•´æŒ‡å—](torch_system.md) - ç«æŠŠéœ€æ±‚å’Œä½¿ç”¨æœºåˆ¶
- [å‰å“¨ç«™ç³»ç»Ÿ](outpost_system.md) - å‰å“¨ç«™ç”Ÿæˆå’Œç®¡ç†
- [äº‹ä»¶ç³»ç»Ÿ](events_system.md) - åœ°æ ‡äº‹ä»¶å¤„ç†
- [ç©å®¶è¿›åº¦ç³»ç»Ÿå®Œæ•´æŒ‡å—](player_progression.md) - ç©å®¶å±æ€§å¢é•¿
- [åœ°å›¾è®¾è®¡æœºåˆ¶åˆ†æ](../a_dark_room_map_design_analysis.md) - åœ°å›¾è®¾è®¡ç†å¿µ
- [åŠŸèƒ½çŠ¶æ€å®Œæ•´æŠ¥å‘Š](../04_project_management/feature_status.md) - å®ç°çŠ¶æ€æŸ¥è¯¢

---

*æœ¬æ–‡æ¡£æ•´åˆäº†terrain_analysis.mdã€terrain_analysis_code_consistency_check.mdã€terrain_analysis_improvement_plan.mdã€terrain_analysis_original_game_comparison.mdã€cave_terrain_verification.mdã€torch_documentation_update_summary.mdç­‰6ä¸ªæ–‡æ¡£çš„å†…å®¹ï¼Œä¸ºå¼€å‘è€…æä¾›ç»Ÿä¸€çš„åœ°å½¢ç³»ç»Ÿå‚è€ƒã€‚*
