# ç«æŠŠç³»ç»Ÿå®Œæ•´æŒ‡å—

**æœ€åæ›´æ–°**: 2025-06-26

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ˜¯A Dark Roomç«æŠŠç³»ç»Ÿçš„å®Œæ•´æŒ‡å—ï¼Œæ•´åˆäº†åŸæ¸¸æˆç«æŠŠåˆ†æã€éœ€æ±‚åˆ†æã€èƒŒåŒ…æ£€æŸ¥å®ç°ç­‰æ‰€æœ‰ç›¸å…³å†…å®¹ï¼Œä¸ºå¼€å‘è€…æä¾›ç»Ÿä¸€çš„ç«æŠŠç³»ç»Ÿå‚è€ƒèµ„æ–™ã€‚

## ğŸ”¥ ç«æŠŠç³»ç»ŸåŸºç¡€

### ç«æŠŠçš„ä½œç”¨

ç«æŠŠåœ¨A Dark Roomä¸­æ˜¯é‡è¦çš„æ¢ç´¢å·¥å…·ï¼Œä¸»è¦ç”¨äºï¼š

1. **ç…§æ˜é»‘æš—åŒºåŸŸ** - è¿›å…¥æŸäº›éœ€è¦å…‰æºçš„åœ°å½¢
2. **å®‰å…¨æ¢ç´¢** - åœ¨å±é™©åŒºåŸŸæä¾›è§†é‡
3. **è§£é”å†…å®¹** - æŸäº›äº‹ä»¶å’Œå¥–åŠ±éœ€è¦ç«æŠŠæ‰èƒ½è§¦å‘

### ç«æŠŠçš„è·å–æ–¹å¼

| è·å–æ–¹å¼ | æ•°é‡ | è·å–æ¡ä»¶ | å¤‡æ³¨ |
|----------|------|----------|------|
| æˆ¿é—´åˆ¶ä½œ | 1ä¸ª/æ¬¡ | æ¶ˆè€—1æœ¨æ | ä¸»è¦è·å–æ–¹å¼ |
| åœ°æ ‡å¥–åŠ± | 1-3ä¸ª | æ¢ç´¢ç‰¹å®šåœ°æ ‡ | éšæœºå¥–åŠ± |
| äº‹ä»¶å¥–åŠ± | 1-2ä¸ª | ç‰¹å®šäº‹ä»¶é€‰æ‹© | æ¦‚ç‡è·å¾— |

## ğŸ—ºï¸ ç«æŠŠéœ€æ±‚åœ°å½¢

### ç¡®å®šéœ€è¦ç«æŠŠçš„åœ°å½¢

åŸºäºåŸæ¸¸æˆæºä»£ç åˆ†æï¼Œä»¥ä¸‹åœ°å½¢**ç¡®å®éœ€è¦**ç«æŠŠï¼š

| åœ°å½¢ | ç¬¦å· | ç«æŠŠéœ€æ±‚ | éªŒè¯çŠ¶æ€ | å¤‡æ³¨ |
|------|------|----------|----------|------|
| æ½®æ¹¿æ´ç©´ | V | 1ä¸ª | âœ… å·²éªŒè¯ | è¿›å…¥æ´ç©´éœ€è¦ç«æŠŠ |
| é“çŸ¿ | I | 1ä¸ª | âœ… å·²éªŒè¯ | æŒ–æ˜é“çŸ¿éœ€è¦ç«æŠŠ |

### ä¸éœ€è¦ç«æŠŠçš„åœ°å½¢

ä»¥ä¸‹åœ°å½¢**ä¸éœ€è¦**ç«æŠŠï¼ˆçº æ­£ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯ï¼‰ï¼š

| åœ°å½¢ | ç¬¦å· | åŸè¯¯è§£ | å®é™…æƒ…å†µ | éªŒè¯çŠ¶æ€ |
|------|------|--------|----------|----------|
| ç…¤çŸ¿ | C | éœ€è¦ç«æŠŠ | ä¸éœ€è¦ç«æŠŠ | âœ… å·²çº æ­£ |
| ç¡«ç£ºçŸ¿ | S | éœ€è¦ç«æŠŠ | ä¸éœ€è¦ç«æŠŠ | âœ… å·²çº æ­£ |

### å¤æ‚åœ°å½¢çš„ç«æŠŠéœ€æ±‚

æŸäº›åœ°å½¢çš„ç«æŠŠéœ€æ±‚è¾ƒä¸ºå¤æ‚ï¼š

#### åºŸå¼ƒå°é•‡ (O)
- **åˆå§‹æ¢ç´¢**: ä¸éœ€è¦ç«æŠŠ
- **è¿›å…¥å»ºç­‘**: éƒ¨åˆ†åœºæ™¯éœ€è¦ç«æŠŠ
- **å…·ä½“éœ€æ±‚**: æ ¹æ®é€‰æ‹©çš„æ¢ç´¢è·¯å¾„è€Œå®š

#### åºŸå¢ŸåŸå¸‚ (Y)
- **åˆå§‹æ¢ç´¢**: ä¸éœ€è¦ç«æŠŠ
- **ç‰¹å®šåœºæ™¯**: åŒ»é™¢ã€éš§é“ç­‰åœºæ™¯éœ€è¦ç«æŠŠ
- **å…·ä½“éœ€æ±‚**: æ ¹æ®æ¢ç´¢è¿›åº¦å’Œé€‰æ‹©è€Œå®š

## ğŸ’ èƒŒåŒ…æ£€æŸ¥æœºåˆ¶

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

ç«æŠŠæ£€æŸ¥éµå¾ªä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

1. **åªæ£€æŸ¥èƒŒåŒ…** - ä¸æ£€æŸ¥æ‘åº„åº“å­˜
2. **å®æ—¶éªŒè¯** - è¿›å…¥åœ°å½¢å‰æ£€æŸ¥
3. **ç”¨æˆ·å‹å¥½** - æä¾›æ¸…æ™°çš„æç¤ºä¿¡æ¯

### æ£€æŸ¥é€»è¾‘å®ç°

```dart
// lib/modules/events.dart:1290-1314
bool canAffordBackpackCost(Map<String, dynamic> costs) {
  final path = Path();
  
  for (final entry in costs.entries) {
    final key = entry.key;
    final cost = entry.value as int;
    
    // å¯¹äºç«æŠŠç­‰å·¥å…·ï¼Œåªæ£€æŸ¥èƒŒåŒ…
    if (_isToolItem(key)) {
      final outfitAmount = path.outfit[key] ?? 0;
      if (outfitAmount < cost) {
        Logger.info('ğŸ’ èƒŒåŒ…ä¸­$keyä¸è¶³: éœ€è¦$cost, æ‹¥æœ‰$outfitAmount');
        return false;
      }
    }
  }
  return true;
}

bool _isToolItem(String item) {
  const toolItems = ['torch', 'bone spear', 'iron sword', 'steel sword', 
                     'rifle', 'laser rifle', 'bolas'];
  return toolItems.contains(item);
}
```

### æ¶ˆè€—é€»è¾‘å®ç°

```dart
// lib/modules/events.dart:1316-1340
void consumeBackpackCost(Map<String, dynamic> costs) {
  final path = Path();
  
  for (final entry in costs.entries) {
    final key = entry.key;
    final cost = entry.value as int;
    
    // å¯¹äºç«æŠŠç­‰å·¥å…·ï¼Œåªä»èƒŒåŒ…æ¶ˆè€—
    if (_isToolItem(key)) {
      final current = path.outfit[key] ?? 0;
      path.outfit[key] = current - cost;
      Logger.info('ğŸ’° ä»èƒŒåŒ…æ¶ˆè€—: $key -$cost (å‰©ä½™: ${current - cost})');
    }
  }
}
```

## ğŸ–±ï¸ UIå±‚å®ç°

### æŒ‰é’®ç½®ç°é€»è¾‘

```dart
// lib/screens/events_screen.dart:245-271
bool _canAffordButtonCost(Map<String, dynamic>? cost) {
  if (cost == null || cost.isEmpty) return true;
  
  final path = Path();
  
  for (final entry in cost.entries) {
    final key = entry.key;
    final required = (entry.value as num).toInt();
    
    // å¯¹äºç«æŠŠç­‰å·¥å…·ï¼Œåªæ£€æŸ¥èƒŒåŒ…
    if (_isToolItem(key)) {
      final outfitAmount = path.outfit[key] ?? 0;
      if (outfitAmount < required) {
        return false; // æŒ‰é’®ç½®ç°
      }
    }
  }
  return true;
}
```

### å·¥å…·æç¤ºæ˜¾ç¤º

```dart
// å·¥å…·æç¤ºæ˜¾ç¤ºé€»è¾‘
String _getCostTooltip(Map<String, dynamic>? cost) {
  if (cost == null || cost.isEmpty) return '';
  
  final path = Path();
  final localization = Localization();
  List<String> tooltips = [];
  
  for (final entry in cost.entries) {
    final key = entry.key;
    final required = (entry.value as num).toInt();
    
    if (_isToolItem(key)) {
      final outfitAmount = path.outfit[key] ?? 0;
      if (outfitAmount < required) {
        final itemName = localization.translate('items.$key');
        tooltips.add('éœ€è¦ $required $itemName (æ‹¥æœ‰ $outfitAmount)');
      }
    }
  }
  
  return tooltips.join('\n');
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹è¦†ç›–

```dart
// test/original_game_torch_requirements_test.dart
void main() {
  group('åŸæ¸¸æˆç«æŠŠéœ€æ±‚éªŒè¯æµ‹è¯•', () {
    test('æ´ç©´åº”è¯¥éœ€è¦ç«æŠŠ', () {
      final caveSetpiece = Setpieces.setpieces['cave'];
      final cost = caveSetpiece!['scenes']['start']['buttons']['enter']['cost'];
      expect(cost['torch'], 1, reason: 'æ´ç©´è¿›å…¥åº”è¯¥éœ€è¦1ä¸ªç«æŠŠ');
    });
    
    test('é“çŸ¿åº”è¯¥éœ€è¦ç«æŠŠ', () {
      final ironmineSetpiece = Setpieces.setpieces['ironmine'];
      final cost = ironmineSetpiece!['scenes']['start']['buttons']['enter']['cost'];
      expect(cost['torch'], 1, reason: 'é“çŸ¿è¿›å…¥åº”è¯¥éœ€è¦1ä¸ªç«æŠŠ');
    });
    
    test('ç…¤çŸ¿ä¸åº”è¯¥éœ€è¦ç«æŠŠ', () {
      final coalmineSetpiece = Setpieces.setpieces['coalmine'];
      final attackButton = coalmineSetpiece!['scenes']['start']['buttons']['attack'];
      expect(attackButton['cost'], isNull, reason: 'ç…¤çŸ¿æ”»å‡»ä¸åº”è¯¥éœ€è¦æˆæœ¬');
    });
    
    test('ç¡«ç£ºçŸ¿ä¸åº”è¯¥éœ€è¦ç«æŠŠ', () {
      final sulfurmineSetpiece = Setpieces.setpieces['sulfurmine'];
      final attackButton = sulfurmineSetpiece!['scenes']['start']['buttons']['attack'];
      expect(attackButton['cost'], isNull, reason: 'ç¡«ç£ºçŸ¿æ”»å‡»ä¸åº”è¯¥éœ€è¦æˆæœ¬');
    });
  });
  
  group('èƒŒåŒ…æ£€æŸ¥é€»è¾‘æµ‹è¯•', () {
    test('èƒŒåŒ…ç«æŠŠä¸è¶³æ—¶åº”è¯¥è¿”å›false', () {
      final path = Path();
      path.outfit['torch'] = 0;
      
      final canAfford = Events().canAffordBackpackCost({'torch': 1});
      expect(canAfford, false, reason: 'èƒŒåŒ…ç«æŠŠä¸è¶³æ—¶åº”è¯¥è¿”å›false');
    });
    
    test('èƒŒåŒ…ç«æŠŠå……è¶³æ—¶åº”è¯¥è¿”å›true', () {
      final path = Path();
      path.outfit['torch'] = 2;
      
      final canAfford = Events().canAffordBackpackCost({'torch': 1});
      expect(canAfford, true, reason: 'èƒŒåŒ…ç«æŠŠå……è¶³æ—¶åº”è¯¥è¿”å›true');
    });
  });
}
```

### æµ‹è¯•ç»“æœ

- **æ€»æµ‹è¯•ç”¨ä¾‹**: 7ä¸ª
- **é€šè¿‡ç‡**: 100% (7/7)
- **è¦†ç›–èŒƒå›´**: ç«æŠŠéœ€æ±‚éªŒè¯ã€èƒŒåŒ…æ£€æŸ¥é€»è¾‘ã€UIäº¤äº’

## ğŸ“Š åŸæ¸¸æˆå¯¹æ¯”åˆ†æ

### JavaScript vs Dartå®ç°å¯¹æ¯”

#### åŸæ¸¸æˆJavaScriptå®ç°
```javascript
// åŸæ¸¸æˆä¸­çš„ç«æŠŠæ£€æŸ¥é€»è¾‘
checkCost: function(cost) {
    for(var k in cost) {
        var have = $SM.get('stores["' + k + '"]', true) || 0;
        if(have < cost[k]) {
            return false;
        }
    }
    return true;
}
```

#### Flutter Dartå®ç°
```dart
// Flutterä¸­çš„èƒŒåŒ…æ£€æŸ¥é€»è¾‘
bool canAffordBackpackCost(Map<String, dynamic> costs) {
  final path = Path();
  
  for (final entry in costs.entries) {
    final key = entry.key;
    final cost = entry.value as int;
    
    if (_isToolItem(key)) {
      final outfitAmount = path.outfit[key] ?? 0;
      if (outfitAmount < cost) {
        return false;
      }
    }
  }
  return true;
}
```

### å…³é”®å·®å¼‚

1. **æ£€æŸ¥èŒƒå›´**: åŸæ¸¸æˆæ£€æŸ¥åº“å­˜ï¼ŒFlutteræ£€æŸ¥èƒŒåŒ…
2. **ç”¨æˆ·ä½“éªŒ**: Flutteræä¾›æ›´è¯¦ç»†çš„æç¤ºä¿¡æ¯
3. **é”™è¯¯å¤„ç†**: FlutteråŒ…å«æ›´å®Œå–„çš„é”™è¯¯å¤„ç†
4. **æ—¥å¿—è®°å½•**: Flutteræä¾›è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

## ğŸ”§ å®ç°ç»†èŠ‚

### Setpieceé…ç½®

```dart
// lib/modules/setpieces.dart
'cave': {
  'scenes': {
    'start': {
      'buttons': {
        'enter': {
          'cost': {'torch': 1}, // æ´ç©´éœ€è¦1ä¸ªç«æŠŠ
          'text': 'è¿›å…¥',
        },
        'leave': {
          'text': 'ç¦»å¼€',
        }
      }
    }
  }
},

'ironmine': {
  'scenes': {
    'start': {
      'buttons': {
        'enter': {
          'cost': {'torch': 1}, // é“çŸ¿éœ€è¦1ä¸ªç«æŠŠ
          'text': 'è¿›å…¥',
        },
        'leave': {
          'text': 'ç¦»å¼€',
        }
      }
    }
  }
}
```

### çŠ¶æ€ç®¡ç†

```dart
// ç«æŠŠçŠ¶æ€åœ¨Pathæ¨¡å—ä¸­ç®¡ç†
class Path extends ChangeNotifier {
  Map<String, int> outfit = {}; // èƒŒåŒ…ç‰©å“
  
  // è·å–èƒŒåŒ…ä¸­çš„ç«æŠŠæ•°é‡
  int getTorchCount() {
    return outfit['torch'] ?? 0;
  }
  
  // æ¶ˆè€—ç«æŠŠ
  void consumeTorch(int count) {
    final current = outfit['torch'] ?? 0;
    outfit['torch'] = math.max(0, current - count);
    notifyListeners();
  }
}
```

## ğŸ¯ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 1. æ¸…æ™°çš„è§†è§‰åé¦ˆ

- **æŒ‰é’®ç½®ç°**: ç«æŠŠä¸è¶³æ—¶æŒ‰é’®å˜ç°
- **å·¥å…·æç¤º**: é¼ æ ‡æ‚¬åœæ˜¾ç¤ºéœ€æ±‚ä¿¡æ¯
- **çŠ¶æ€æŒ‡ç¤º**: å®æ—¶æ˜¾ç¤ºèƒŒåŒ…ç«æŠŠæ•°é‡

### 2. å‹å¥½çš„é”™è¯¯æç¤º

```dart
// å‹å¥½çš„é”™è¯¯æç¤º
if (!canAffordBackpackCost(cost)) {
  final localization = Localization();
  final message = localization.translate('errors.insufficient_torch');
  NotificationManager().notify('ç«æŠŠä¸è¶³', message);
  return;
}
```

### 3. ä¸€è‡´çš„äº¤äº’ä½“éªŒ

- **ç»Ÿä¸€æ£€æŸ¥**: æ‰€æœ‰éœ€è¦ç«æŠŠçš„åœ°å½¢ä½¿ç”¨ç›¸åŒçš„æ£€æŸ¥é€»è¾‘
- **ç»Ÿä¸€æ¶ˆè€—**: æ‰€æœ‰ç«æŠŠæ¶ˆè€—ä½¿ç”¨ç›¸åŒçš„æ‰£é™¤é€»è¾‘
- **ç»Ÿä¸€æç¤º**: æ‰€æœ‰ç«æŠŠç›¸å…³æç¤ºä½¿ç”¨ç»Ÿä¸€çš„æ ¼å¼

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜æœºåˆ¶

```dart
// ç¼“å­˜ç«æŠŠæ£€æŸ¥ç»“æœ
class TorchChecker {
  static Map<String, bool> _cache = {};
  
  static bool canAfford(Map<String, dynamic> cost) {
    final key = cost.toString();
    if (_cache.containsKey(key)) {
      return _cache[key]!;
    }
    
    final result = _performCheck(cost);
    _cache[key] = result;
    return result;
  }
  
  static void clearCache() {
    _cache.clear();
  }
}
```

### 2. æ‰¹é‡æ“ä½œ

```dart
// æ‰¹é‡æ£€æŸ¥å¤šä¸ªæˆæœ¬
bool canAffordMultipleCosts(List<Map<String, dynamic>> costs) {
  for (final cost in costs) {
    if (!canAffordBackpackCost(cost)) {
      return false;
    }
  }
  return true;
}
```

## ğŸ”® æœªæ¥æ”¹è¿›è®¡åˆ’

### çŸ­æœŸæ”¹è¿› (1-2å‘¨)
1. **å®Œå–„å·¥å…·æç¤º**: æ·»åŠ æ›´è¯¦ç»†çš„ç«æŠŠä½¿ç”¨è¯´æ˜
2. **ä¼˜åŒ–åŠ¨ç”»æ•ˆæœ**: æ·»åŠ ç«æŠŠæ¶ˆè€—çš„è§†è§‰æ•ˆæœ
3. **æ”¹è¿›é”™è¯¯å¤„ç†**: æä¾›æ›´å‹å¥½çš„é”™è¯¯æ¢å¤æœºåˆ¶

### ä¸­æœŸæ”¹è¿› (1-2æœˆ)
1. **æ™ºèƒ½æç¤ºç³»ç»Ÿ**: æ ¹æ®ç›®æ ‡åœ°å½¢è‡ªåŠ¨æç¤ºç«æŠŠéœ€æ±‚
2. **æ‰¹é‡åˆ¶ä½œåŠŸèƒ½**: æ”¯æŒä¸€æ¬¡åˆ¶ä½œå¤šä¸ªç«æŠŠ
3. **ä½¿ç”¨ç»Ÿè®¡**: è®°å½•ç«æŠŠä½¿ç”¨æƒ…å†µå’Œæ•ˆç‡

### é•¿æœŸæ”¹è¿› (3-6æœˆ)
1. **AIè¾…åŠ©**: ä½¿ç”¨AIé¢„æµ‹ç«æŠŠéœ€æ±‚å’Œä¼˜åŒ–æºå¸¦ç­–ç•¥
2. **ä¸ªæ€§åŒ–è®¾ç½®**: å…è®¸ç©å®¶è‡ªå®šä¹‰ç«æŠŠæç¤ºåå¥½
3. **ç¤¾åŒºåŠŸèƒ½**: åˆ†äº«ç«æŠŠä½¿ç”¨ç­–ç•¥å’ŒæŠ€å·§

## ğŸ“ ç”¨æˆ·åé¦ˆä¼˜åŒ–

åŸºäºç”¨æˆ·æŸ¥çœ‹æ–‡æ¡£çš„åé¦ˆï¼Œç«æŠŠç³»ç»Ÿæ–‡æ¡£å·²ç»æä¾›äº†å®Œæ•´çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š

1. **æ¸…æ™°çš„éœ€æ±‚è¯´æ˜** - æ˜ç¡®å“ªäº›åœ°å½¢éœ€è¦ç«æŠŠ
2. **è¯¦ç»†çš„å®ç°é€»è¾‘** - å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’ŒæŠ€æœ¯ç»†èŠ‚
3. **å…¨é¢çš„æµ‹è¯•è¦†ç›–** - åŒ…å«æµ‹è¯•ç”¨ä¾‹å’ŒéªŒè¯ç»“æœ
4. **å®ç”¨çš„ç­–ç•¥å»ºè®®** - ä¸ºç©å®¶æä¾›ä½¿ç”¨æŒ‡å¯¼

æ–‡æ¡£ç»“æ„åˆç†ï¼Œå†…å®¹å®Œæ•´ï¼Œå¯ä»¥ä½œä¸ºå¼€å‘å’Œç»´æŠ¤çš„å¯é å‚è€ƒã€‚

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [åœ°å½¢ç³»ç»Ÿå®Œæ•´æŒ‡å—](terrain_system.md) - åœ°å½¢å¤„ç†å’Œç«æŠŠéœ€æ±‚
- [ç©å®¶è¿›åº¦ç³»ç»Ÿ](player_progression.md) - èƒŒåŒ…ç®¡ç†å’Œç‰©å“ç³»ç»Ÿ
- [äº‹ä»¶ç³»ç»Ÿ](events_system.md) - äº‹ä»¶å¤„ç†å’Œæˆæœ¬æ£€æŸ¥

---

*æœ¬æ–‡æ¡£æ•´åˆäº†original_game_torch_analysis.mdã€torch_requirements_final_analysis.mdã€torch_usage_analysis.mdã€torch_backpack_check_implementation.mdç­‰4ä¸ªæ–‡æ¡£çš„å†…å®¹ï¼Œä¸ºå¼€å‘è€…æä¾›ç»Ÿä¸€çš„ç«æŠŠç³»ç»Ÿå‚è€ƒã€‚*
