name: è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'

jobs:
  test-coverage:
    name: æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: è·å–ä¾èµ–
      run: flutter pub get
      
    - name: è¿è¡Œä»£ç åˆ†æ
      run: flutter analyze
      
    - name: è¿è¡Œæ ¸å¿ƒç³»ç»Ÿæµ‹è¯•
      run: |
        echo "ğŸ¯ è¿è¡Œæ ¸å¿ƒç³»ç»Ÿæµ‹è¯•..."
        dart test/run_coverage_tests.dart --category core --verbose
      continue-on-error: true
      
    - name: è¿è¡Œæ¸¸æˆæ¨¡å—æµ‹è¯•
      run: |
        echo "ğŸ® è¿è¡Œæ¸¸æˆæ¨¡å—æµ‹è¯•..."
        dart test/run_coverage_tests.dart --category modules --verbose
      continue-on-error: true
      
    - name: è¿è¡ŒUIç»„ä»¶æµ‹è¯•
      run: |
        echo "ğŸ–¥ï¸ è¿è¡ŒUIç»„ä»¶æµ‹è¯•..."
        dart test/run_coverage_tests.dart --category ui --verbose
      continue-on-error: true
      
    - name: è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶æ£€æŸ¥è¦†ç›–ç‡
      run: |
        echo "ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
        dart test/run_coverage_tests.dart --threshold 20 --verbose
        
    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-coverage-report
        path: docs/test_coverage_report.md
        retention-days: 30
        
    - name: è¯„è®ºPRè¦†ç›–ç‡ç»“æœ
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = 'docs/test_coverage_report.md';
          
          if (fs.existsSync(path)) {
            const report = fs.readFileSync(path, 'utf8');
            
            // æå–å…³é”®ä¿¡æ¯
            const coverageMatch = report.match(/å·²è¦†ç›–æ–‡ä»¶æ•°.*?(\d+)%/);
            const totalTestsMatch = report.match(/æµ‹è¯•æ–‡ä»¶æ€»æ•°.*?(\d+)/);
            
            const coverage = coverageMatch ? coverageMatch[1] : 'æœªçŸ¥';
            const totalTests = totalTestsMatch ? totalTestsMatch[1] : 'æœªçŸ¥';
            
            const comment = `## ğŸ§ª æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
            
            **æµ‹è¯•è¦†ç›–ç‡**: ${coverage}%
            **æµ‹è¯•æ–‡ä»¶æ€»æ•°**: ${totalTests}
            
            ${coverage < 80 ? 'âš ï¸ è¦†ç›–ç‡ä½äº80%ï¼Œå»ºè®®æ·»åŠ æ›´å¤šæµ‹è¯•' : 'âœ… è¦†ç›–ç‡è‰¯å¥½'}
            
            è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ [æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š](../blob/${context.sha}/docs/test_coverage_report.md)
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

  performance-test:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: test-coverage
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: è·å–ä¾èµ–
      run: flutter pub get
      
    - name: æ„å»ºWebç‰ˆæœ¬
      run: flutter build web --release
      
    - name: æ£€æŸ¥æ„å»ºäº§ç‰©å¤§å°
      run: |
        echo "ğŸ“¦ æ£€æŸ¥æ„å»ºäº§ç‰©å¤§å°..."
        du -sh build/web/
        
        # æ£€æŸ¥ä¸»è¦æ–‡ä»¶å¤§å°
        if [ -f "build/web/main.dart.js" ]; then
          size=$(stat -c%s "build/web/main.dart.js")
          echo "main.dart.js å¤§å°: $((size / 1024))KB"
          
          # å¦‚æœè¶…è¿‡5MBåˆ™è­¦å‘Š
          if [ $size -gt 5242880 ]; then
            echo "âš ï¸ è­¦å‘Š: main.dart.js æ–‡ä»¶è¿‡å¤§ (>5MB)"
          fi
        fi
        
    - name: è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
      run: |
        echo "âš¡ è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„æ€§èƒ½æµ‹è¯•å‘½ä»¤
        echo "æ€§èƒ½æµ‹è¯•å®Œæˆ"

  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¿è¡Œä¾èµ–å®‰å…¨æ‰«æ
      run: |
        echo "ğŸ”’ æ£€æŸ¥ä¾èµ–å®‰å…¨æ€§..."
        # æ£€æŸ¥pubspec.yamlä¸­çš„ä¾èµ–
        if [ -f "pubspec.yaml" ]; then
          echo "æ£€æŸ¥Flutterä¾èµ–..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„å®‰å…¨æ‰«æå·¥å…·
        fi
        
    - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
      run: |
        echo "ğŸ” æ£€æŸ¥æ•æ„Ÿä¿¡æ¯..."
        # æ£€æŸ¥æ˜¯å¦æœ‰APIå¯†é’¥ã€å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
        if grep -r "api_key\|password\|secret" --include="*.dart" lib/; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯"
          exit 1
        else
          echo "âœ… æœªå‘ç°æ•æ„Ÿä¿¡æ¯"
        fi

  deploy-preview:
    name: éƒ¨ç½²é¢„è§ˆ
    runs-on: ubuntu-latest
    needs: [test-coverage, performance-test]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: è·å–ä¾èµ–
      run: flutter pub get
      
    - name: æ„å»ºWebç‰ˆæœ¬
      run: flutter build web --release
      
    - name: éƒ¨ç½²åˆ°GitHub Pages (é¢„è§ˆ)
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build/web
        destination_dir: preview/${{ github.event.number }}
        
    - name: è¯„è®ºé¢„è§ˆé“¾æ¥
      uses: actions/github-script@v7
      with:
        script: |
          const comment = `## ğŸš€ é¢„è§ˆéƒ¨ç½²å®Œæˆ
          
          é¢„è§ˆé“¾æ¥: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/preview/${{ github.event.number }}/
          
          æ­¤é¢„è§ˆå°†åœ¨PRåˆå¹¶æˆ–å…³é—­åè‡ªåŠ¨æ¸…ç†ã€‚
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  notify-results:
    name: é€šçŸ¥ç»“æœ
    runs-on: ubuntu-latest
    needs: [test-coverage, performance-test, security-scan]
    if: always()
    
    steps:
    - name: å‘é€é€šçŸ¥
      run: |
        echo "ğŸ“¢ å·¥ä½œæµç¨‹å®Œæˆ"
        echo "æµ‹è¯•è¦†ç›–ç‡: ${{ needs.test-coverage.result }}"
        echo "æ€§èƒ½æµ‹è¯•: ${{ needs.performance-test.result }}"
        echo "å®‰å…¨æ‰«æ: ${{ needs.security-scan.result }}"
        
        if [ "${{ needs.test-coverage.result }}" = "success" ] && 
           [ "${{ needs.performance-test.result }}" = "success" ] && 
           [ "${{ needs.security-scan.result }}" = "success" ]; then
          echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡!"
        else
          echo "ğŸ’¥ å­˜åœ¨å¤±è´¥çš„æ£€æŸ¥ï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…"
        fi
